<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PBX Prompt Builder ‚Äî Formulaire (Contexte / O√π / Quoi / Limites / Approche)</title>
  <style>
    :root{
      --bg:#F6F7FB;
      --card:#FFFFFF;
      --ink:#0F172A;
      --muted:#64748B;
      --muted2:#94A3B8;
      --line:#E2E8F0;

      --primary:#6D28D9;
      --teal:#14B8A6;

      --good:#22C55E;
      --warn:#F59E0B;
      --bad:#EF4444;

      --shadow: 0 14px 40px rgba(15, 23, 42, 0.10);
      --shadow2: 0 10px 26px rgba(15, 23, 42, 0.07);

      --r:18px;
      --r2:14px;
    }

    *{ box-sizing:border-box; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", sans-serif; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 520px at 15% -10%, rgba(109,40,217,0.16), transparent 55%),
        radial-gradient(1200px 520px at 85% -10%, rgba(20,184,166,0.14), transparent 55%),
        var(--bg);
      color:var(--ink);
      min-height:100vh;
      padding: 20px 14px 46px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }

    .wrap{ width:100%; max-width: 1200px; }

    /* Header */
    .top{
      display:flex;
      gap:14px;
      justify-content:space-between;
      align-items:flex-start;
      flex-wrap:wrap;
      margin-bottom: 14px;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:flex-start;
      min-width: 280px;
      flex: 1 1 740px;
    }
    .logo{
      width:44px; height:44px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--primary), var(--teal));
      box-shadow: var(--shadow2);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:950;
      letter-spacing:-0.3px;
      flex-shrink:0;
    }
    h1{
      margin:0;
      font-size: 22px;
      letter-spacing:-0.2px;
      line-height:1.2;
    }
    .sub{
      margin:5px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height:1.35;
      max-width: 960px;
    }

    .metaPills{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      flex: 1 1 360px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,0.88);
      box-shadow: 0 10px 22px rgba(15,23,42,0.05);
      font-size: 12.5px;
      color: var(--muted);
      white-space:nowrap;
    }
    .dot{
      width:9px; height:9px; border-radius:999px;
      background: var(--muted2);
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11.5px;
      padding: 2px 6px;
      border-radius: 8px;
      background: rgba(2,6,23,0.06);
      border: 1px solid rgba(15,23,42,0.10);
      color: #0f172a;
      white-space: nowrap;
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1fr 380px;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 1020px){
      .grid{ grid-template-columns: 1fr; }
      .side{ position: static !important; }
    }

    .card{
      background: rgba(255,255,255,0.92);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow2);
    }
    .card .inner{ padding: 16px; }

    /* Form blocks */
    .hero{
      border: 1px solid var(--line);
      border-radius: 18px;
      background: rgba(255,255,255,0.78);
      padding: 14px;
      margin-bottom: 12px;
    }
    .heroHead{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .heroLeft{ display:flex; gap:10px; align-items:flex-start; }
    .heroIcon{
      width:36px; height:36px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(109,40,217,0.12), rgba(20,184,166,0.12));
      border: 1px solid rgba(109,40,217,0.18);
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--primary);
      font-weight: 950;
      flex-shrink:0;
    }
    .heroTitle{ margin:0; font-size: 14px; font-weight: 950; letter-spacing:-0.15px; }
    .heroDesc{ margin:3px 0 0; font-size: 12.5px; color: var(--muted); line-height:1.35; }

    .tags{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .tag{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--muted);
      white-space:nowrap;
    }
    .tag.req{
      border-color: rgba(239,68,68,0.22);
      background: rgba(239,68,68,0.06);
      color: #991B1B;
      font-weight: 900;
    }

    .label{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin: 10px 0 6px;
    }
    .label span{
      font-size: 12.7px;
      font-weight: 950;
      letter-spacing:-0.1px;
    }
    .help{ font-size: 11.7px; color: var(--muted2); }
    .counter{ font-size: 11.7px; color: var(--muted2); white-space:nowrap; }

    textarea, input[type="text"]{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(248,250,252,0.85);
      padding: 11px 12px;
      font-size: 13.8px;
      outline:none;
      transition: border-color .15s, box-shadow .15s, background .15s;
      line-height: 1.35;
    }
    textarea{ min-height: 120px; resize: vertical; }
    textarea:focus, input:focus{
      border-color: rgba(109,40,217,0.55);
      box-shadow: 0 0 0 3px rgba(109,40,217,0.18);
      background: #fff;
    }

    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 860px){ .row2{ grid-template-columns: 1fr; } }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top: 10px;
    }
    .chip{
      border: 1px solid var(--line);
      background: #fff;
      color: var(--ink);
      font-weight: 900;
      font-size: 12.5px;
      padding: 8px 10px;
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 8px 18px rgba(15,23,42,0.04);
      transition: transform .06s ease, border-color .15s ease;
    }
    .chip:active{ transform: translateY(1px); }
    .chip:hover{ border-color: rgba(109,40,217,0.35); }

    .hint{
      margin-top: 10px;
      padding: 10px 11px;
      border-radius: 14px;
      border: 1px dashed rgba(100,116,139,0.24);
      background: rgba(2,6,23,0.03);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .hint strong{ color: var(--ink); }

    /* Sidebar */
    .side{ position: sticky; top: 14px; }

    .qTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom: 10px;
    }
    .qTop h3{
      margin:0;
      font-size: 14px;
      font-weight: 950;
      letter-spacing:-0.15px;
    }
    .scorePill{
      font-size: 12.5px;
      font-weight: 950;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--muted);
      white-space:nowrap;
    }
    .bar{
      height: 10px;
      background: #E2E8F0;
      border-radius: 999px;
      overflow:hidden;
      margin-bottom: 10px;
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: var(--good);
      transition: width .2s ease, background .2s ease;
    }

    .checks{
      display:grid;
      gap:10px;
      margin-top: 10px;
    }
    .item{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.86);
    }
    .ico{
      width:26px; height:26px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight: 950;
      flex-shrink:0;
      background: var(--muted2);
    }
    .item.ok .ico{ background: var(--good); }
    .item.warn .ico{ background: var(--warn); }
    .item.bad .ico{ background: var(--bad); }

    .itT{ margin:0; font-size: 12.6px; font-weight: 950; letter-spacing:-0.1px; }
    .itD{ margin: 2px 0 0; font-size: 12px; color: var(--muted); line-height:1.35; }

    .actions{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 12px;
    }
    .btn{
      border: none;
      border-radius: 16px;
      padding: 11px 12px;
      font-size: 13.7px;
      font-weight: 950;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition: transform .06s ease, opacity .15s ease, box-shadow .15s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, var(--primary), var(--teal));
      color:#fff;
      box-shadow: 0 14px 30px rgba(109,40,217,0.20);
    }
    .btn.ghost{
      background: #fff;
      border: 1px solid var(--line);
      color: var(--ink);
    }
    .btn.danger{
      background: rgba(239,68,68,0.08);
      border: 1px solid rgba(239,68,68,0.22);
      color: #991B1B;
    }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; box-shadow:none; }

    .mini{
      margin-top: 10px;
      font-size: 12px;
      line-height:1.35;
      color: var(--muted);
    }

    /* Result */
    .resultHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 8px;
    }
    .resultHead h3{
      margin:0;
      font-size: 14px;
      font-weight: 950;
      letter-spacing:-0.15px;
    }
    .badge{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--muted);
      white-space:nowrap;
    }
    #result{
      width:100%;
      min-height: 240px;
      border-radius: 16px;
      border: none;
      outline:none;
      padding: 12px 12px;
      background: #020617;
      color: #E5E7EB;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12.8px;
      line-height: 1.45;
      white-space: pre-wrap;
    }
    .toast{
      display:none;
      margin-top: 8px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(34,197,94,0.25);
      background: rgba(34,197,94,0.08);
      color: #14532D;
      font-weight: 950;
      font-size: 12.5px;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">PBX</div>
        <div>
          <h1>PBX Prompt Builder ‚Äî Formulaire</h1>
          <p class="sub">
            Objectif : produire un prompt PBX <strong>r√©plicable</strong> et <strong>robuste</strong> (Contexte / O√π / Quoi / Limites / Approche).
            La g√©n√©ration est bloqu√©e si une section critique est trop vague (anti-cr√©dits).
          </p>
        </div>
      </div>

      <div class="metaPills">
        <div class="pill"><span class="dot" id="dotState"></span><span id="stateLabel">Prompt incomplet</span></div>
        <div class="pill">Raccourci : <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span></div>
      </div>
    </div>

    <div class="grid">
      <!-- MAIN -->
      <div>
        <div class="card">
          <div class="inner">

            <!-- Contexte -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">‚ë†</div>
                  <div>
                    <p class="heroTitle">Contexte</p>
                    <p class="heroDesc">URL / type de page / dynamique (overlay, lazy-load, ‚Äúvoir tout‚Äù).</p>
                  </div>
                </div>
                <div class="tags">
                  <span class="tag req">Obligatoire</span>
                </div>
              </div>

              <div class="label">
                <span>Contexte</span>
                <span class="counter" id="c_context"></span>
              </div>
              <textarea id="context" placeholder="Ex : URL: https://‚Ä¶ / listing. Les tuiles sont pr√©sentes au chargement initial + ajout√©es apr√®s clic sur ‚Äúvoir tout‚Äù. Une overlay d√©tail peut s‚Äôouvrir/fermer."></textarea>

              <div class="hint">
                <strong>√Ä inclure :</strong> URL + √©tats √† couvrir (initial / apr√®s clic / overlay) + si contenu inject√© dynamiquement.
              </div>
            </div>

            <!-- O√π -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">‚ë°</div>
                  <div>
                    <p class="heroTitle">O√π ?</p>
                    <p class="heroDesc">Cible sans ambigu√Øt√© : quelles tuiles / quel bloc / quelle zone exacte.</p>
                  </div>
                </div>
                <div class="tags">
                  <span class="tag req">Obligatoire</span>
                </div>
              </div>

              <div class="label">
                <span>O√π (cible + rep√®res)</span>
                <span class="counter" id="c_where"></span>
              </div>
              <textarea id="where" placeholder="Ex : Cible : tuiles ‚ÄúiPhone 17‚Äù, ‚ÄúiPhone 17 Pro‚Äù, ‚ÄúiPhone 17 Pro Max‚Äù. Dans chaque tuile, ins√©rer un texte sous l‚Äôimage du t√©l√©phone, centr√©."></textarea>

              <div class="chips" aria-label="Exemples rapides (O√π)">
                <div class="chip" data-target="where" data-add="Cible : toutes les tuiles forfaits visibles au chargement initial + celles ajout√©es via ‚Äúvoir tout‚Äù + celles dans l‚Äôoverlay ‚Äúvoir le d√©tail‚Äù.">Tuiles + overlay</div>
                <div class="chip" data-target="where" data-add="Dans chaque tuile, cibler la ligne de texte situ√©e juste au-dessus du prix affich√© (bloc prix).">Texte au-dessus du prix</div>
                <div class="chip" data-target="where" data-add="Sous l‚Äôimage produit dans la tuile, align√© au centre, dans le m√™me conteneur que le titre/sous-titre.">Sous image, centr√©</div>
              </div>
            </div>

            <!-- Quoi -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">‚ë¢</div>
                  <div>
                    <p class="heroTitle">Quoi ?</p>
                    <p class="heroDesc">Le changement exact (Add / Replace / Transform) + contenu / calcul / format.</p>
                  </div>
                </div>
                <div class="tags">
                  <span class="tag req">Obligatoire</span>
                </div>
              </div>

              <div class="label">
                <span>Quoi (action + contenu)</span>
                <span class="counter" id="c_what"></span>
              </div>
              <textarea id="what" placeholder="Ex : Ajouter le texte EXACT : ‚Äú√Ä partir d‚Äô1‚Ç¨ avec la souscription sur le forfait 410 Go, apr√®s rachat de votre iPhone 14 Pro (ou ult√©rieur)‚Äù."></textarea>

              <div class="hint">
                <strong>Si calcul :</strong> d√©crire valeurs √† extraire + formule + format final (ex : ‚Äú9,99‚Ç¨/mois‚Äù).<br>
                <strong>Si remplacement :</strong> pr√©ciser ‚Äúremplacer uniquement X, ne pas toucher √† Y‚Äù.
              </div>
            </div>

            <!-- Limites -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">‚ë£</div>
                  <div>
                    <p class="heroTitle">Limites</p>
                    <p class="heroDesc">Ce qui ne doit pas bouger (charte, layout) + r√®gles de style non n√©gociables.</p>
                  </div>
                </div>
                <div class="tags">
                  <span class="tag">Recommand√© (fort)</span>
                </div>
              </div>

              <div class="label">
                <span>Limites / contraintes</span>
                <span class="counter" id="c_limits"></span>
              </div>
              <textarea id="limits" placeholder="Ex : Respecter la charte graphique (fond greige), typographie, taille et position. Ne pas changer la grille / layout. Le message doit rester lisible sans d√©naturer le design."></textarea>
            </div>

            <!-- Approche -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">‚ë§</div>
                  <div>
                    <p class="heroTitle">Approche</p>
                    <p class="heroDesc">Robustesse : dynamique, overlays, r√©-application, idempotence (pas de doublons).</p>
                  </div>
                </div>
                <div class="tags">
                  <span class="tag">Recommand√©</span>
                </div>
              </div>

              <div class="label">
                <span>Approche technique</span>
                <span class="counter" id="c_approach"></span>
              </div>
              <textarea id="approach" placeholder="Ex : Le code doit s‚Äôappliquer au chargement + se r√©appliquer lors des ajouts dynamiques (MutationObserver). Idempotent (marquer data-processed). Doit fonctionner dans l‚Äôoverlay apr√®s ouverture/fermeture."></textarea>

              <div class="chips" aria-label="Exemples rapides (Approche)">
                <div class="chip" data-target="approach" data-add="Appliquer au chargement initial + r√©appliquer sur ajouts DOM via MutationObserver. Idempotent : ne jamais dupliquer les √©l√©ments (data-processed).">MutationObserver + idempotent</div>
                <div class="chip" data-target="approach" data-add="√âcouter les clics sur ‚Äúvoir tout‚Äù et ‚Äúvoir le d√©tail‚Äù, puis relancer apply() apr√®s rendu. Maintenir le comportement apr√®s ouverture/fermeture d‚Äôoverlay.">Clics + overlays</div>
                <div class="chip" data-target="approach" data-add="Fallback : si la tuile ne contient pas les √©l√©ments attendus, ne rien modifier (pas d‚Äôerreur console).">Fallback safe</div>
              </div>
            </div>

            <!-- Verification -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">‚ë•</div>
                  <div>
                    <p class="heroTitle">V√©rification attendue</p>
                    <p class="heroDesc">Crit√®res de succ√®s visibles (persistance, overlay, style barr√©/gras, etc.).</p>
                  </div>
                </div>
                <div class="tags">
                  <span class="tag">Optionnel</span>
                </div>
              </div>

              <div class="label">
                <span>V√©rification</span>
                <span class="counter" id="c_verify"></span>
              </div>
              <textarea id="verify" placeholder="Ex : Le texte reste pr√©sent apr√®s interactions. Dans l‚Äôoverlay, il est visible. Si affichage d‚Äôun prix calcul√©, il doit √™tre barr√© et gris dans tous les √©tats."></textarea>
            </div>

            <!-- RESULT -->
            <div class="card">
              <div class="inner">
                <div class="resultHead">
                  <h3>Prompt PBX pr√™t √† coller</h3>
                  <span class="badge" id="genBadge">Incomplet</span>
                </div>
                <textarea id="result" readonly placeholder="Clique ‚ÄúValider‚Äù (questions) ou ‚ÄúG√©n√©rer‚Äù."></textarea>
                <div class="toast" id="toast">Copi√© ‚úÖ</div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- SIDEBAR -->
      <div class="side">
        <div class="card">
          <div class="inner">
            <div class="qTop">
              <h3>Contr√¥le qualit√©</h3>
              <div class="scorePill" id="scorePill">0% ‚õî</div>
            </div>
            <div class="bar"><div id="scoreBar"></div></div>

            <div class="checks" id="checks"></div>

            <div class="actions">
              <button class="btn ghost" id="btnValidate" type="button">üß™ Valider (3 questions max)</button>
              <button class="btn primary" id="btnGenerate" type="button" disabled>‚öôÔ∏è G√©n√©rer le prompt</button>
              <button class="btn ghost" id="btnCopy" type="button" disabled>üìã Copier</button>
              <button class="btn danger" id="btnReset" type="button">üóëÔ∏è R√©initialiser</button>
            </div>

            <div class="mini">
              La g√©n√©ration est bloqu√©e si <strong>Contexte / O√π / Quoi</strong> sont trop vagues.
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);
  const SKEY = "pbx_prompt_form_v2";

  const els = {
    context: $("context"),
    where: $("where"),
    what: $("what"),
    limits: $("limits"),
    approach: $("approach"),
    verify: $("verify"),

    result: $("result"),
    toast: $("toast"),

    btnValidate: $("btnValidate"),
    btnGenerate: $("btnGenerate"),
    btnCopy: $("btnCopy"),
    btnReset: $("btnReset"),

    scorePill: $("scorePill"),
    scoreBar: $("scoreBar"),
    checks: $("checks"),

    dotState: $("dotState"),
    stateLabel: $("stateLabel"),
    genBadge: $("genBadge"),

    c_context: $("c_context"),
    c_where: $("c_where"),
    c_what: $("c_what"),
    c_limits: $("c_limits"),
    c_approach: $("c_approach"),
    c_verify: $("c_verify"),
  };

  // Heuristiques "anti-vague"
  const vagueMarkers = [
    "am√©liorer","optimiser","faire mieux","rendre plus","peaufiner","comme tu veux","√† ta guise","peu importe",
    "make it better","optimize","improve"
  ];

  const actionVerbsFR = ["ajouter","remplacer","modifier","d√©placer","supprimer","r√©√©crire","ins√©rer","mettre √† jour","transformer","calculer","afficher"];
  const actionVerbsEN = ["add","replace","change","move","remove","rewrite","insert","update","transform","calculate","display"];

  function countChars(v){ return (v || "").trim().length; }
  function setCounter(el, v){ el.textContent = countChars(v) ? `${countChars(v)} car.` : ""; }

  function looksVagueSection(text, kind){
    const t = (text || "").trim();
    if(!t) return true;

    const low = t.toLowerCase();
    const hasVague = vagueMarkers.some(m => low.includes(m));

    // Contexte: veut URL/√©tats, pas juste "page produit"
    if(kind === "context"){
      const hasUrl = /(https?:\/\/|www\.)/i.test(t);
      const hasState = /(chargement|initial|overlay|modal|voir tout|voir le d√©tail|pagination|filtre|lazy|dynamique|scroll)/i.test(t);
      if(t.length < 40) return true;
      if(hasVague && !hasUrl && !hasState) return true;
      if(!hasUrl && !hasState) return true;
      return false;
    }

    // O√π: veut cible/zone, pas "sur la page"
    if(kind === "where"){
      const hasTargetHint = /(tuile|carte|bloc|section|bouton|cta|prix|image|h1|titre|ligne|au-dessus|en dessous|sous|centr√©|droite|gauche|overlay|modal)/i.test(t);
      const hasSpecific = /["‚Äú‚Äù']|\b(iPhone|forfait|prix|‚Ç¨/mois)\b/i.test(t);
      if(t.length < 35) return true;
      if(hasVague && !hasTargetHint) return true;
      if(!hasTargetHint && !hasSpecific) return true;
      return false;
    }

    // Quoi: veut action + contenu/format (ou formule)
    if(kind === "what"){
      const hasVerb = [...actionVerbsFR, ...actionVerbsEN].some(v => low.includes(v));
      const hasConcrete = /["‚Äú‚Äù']|\b\d+([,.]\d+)?\b|‚Ç¨|\/mois|format|formule|calcul/i.test(t);
      if(t.length < 35) return true;
      if(!hasVerb) return true;
      if(hasVague && !hasConcrete) return true;
      if(!hasConcrete) return true;
      return false;
    }

    // Limites: facultatif mais si rempli trop vague, on warn
    if(kind === "limits"){
      if(t.length < 18) return true;
      return false;
    }

    // Approche: facultatif mais important si dynamique mentionn√©
    if(kind === "approach"){
      if(t.length < 18) return true;
      return false;
    }

    return false;
  }

  function needsApproachFromContext(){
    const t = `${els.context.value} ${els.where.value}`.toLowerCase();
    return /(overlay|modal|voir tout|voir le d√©tail|pagination|filtre|lazy|dynamique|ajax|infinite|scroll)/i.test(t);
  }

  function computeQuality(){
    const missing = [];
    const warnings = [];

    const ctx = els.context.value.trim();
    const whr = els.where.value.trim();
    const wht = els.what.value.trim();
    const lim = els.limits.value.trim();
    const app = els.approach.value.trim();

    // Critiques : Contexte / O√π / Quoi
    if(!ctx || looksVagueSection(ctx,"context")){
      missing.push({t:"Contexte insuffisant", d:"Ajoute URL + √©tats (initial / apr√®s clic / overlay) ou mention explicite du dynamisme.", lvl:"bad"});
    }
    if(!whr || looksVagueSection(whr,"where")){
      missing.push({t:"O√π ? trop flou", d:"Pr√©cise la cible (tuiles / bloc) + position exacte (ex : sous l‚Äôimage, au-dessus du prix).", lvl:"bad"});
    }
    if(!wht || looksVagueSection(wht,"what")){
      missing.push({t:"Quoi ? trop vague", d:"Donne l‚Äôaction (ajouter/remplacer/calculer) + texte exact ou format / formule.", lvl:"bad"});
    }

    // Limites recommand√©es
    if(!lim){
      warnings.push({t:"Limites manquantes (reco)", d:"Ajoute ce qui ne doit pas bouger : charte, fond greige, typo, layout.", lvl:"warn"});
    } else if(looksVagueSection(lim,"limits")){
      warnings.push({t:"Limites impr√©cises", d:"Sois concret : ‚Äúne pas changer layout‚Äù, ‚Äúrespecter fond greige‚Äù, ‚Äúgarder typo/tailles‚Äù.", lvl:"warn"});
    }

    // Approche recommand√©e si dynamique
    const needApp = needsApproachFromContext();
    if(needApp && !app){
      warnings.push({t:"Approche manquante (reco)", d:"La page semble dynamique : demande r√©-application (MutationObserver / apply idempotent / overlays).", lvl:"warn"});
    } else if(app && looksVagueSection(app,"approach")){
      warnings.push({t:"Approche trop courte", d:"D√©cris : r√©-application, idempotence (data-processed), overlay open/close, fallback sans erreur.", lvl:"warn"});
    }

    // Score
    let score = 100;
    score -= missing.length * 38;
    score -= warnings.length * 12;
    score = Math.max(0, Math.min(100, score));

    const ready = (missing.length === 0 && score >= 70);
    const state = ready ? "ready" : (score >= 50 ? "warn" : "bad");
    return {score, ready, state, missing, warnings, needApp};
  }

  function renderChecks(q){
    const items = [];
    const add = (state, title, desc) => {
      const icon = state === "ok" ? "‚úì" : (state === "warn" ? "!" : "√ó");
      items.push(`
        <div class="item ${state}">
          <div class="ico">${icon}</div>
          <div>
            <p class="itT">${title}</p>
            <p class="itD">${desc}</p>
          </div>
        </div>
      `);
    };

    const ctxOk = els.context.value.trim() && !looksVagueSection(els.context.value,"context");
    add(ctxOk ? "ok" : "bad", "Contexte", ctxOk ? "OK ‚Äî URL/√©tats suffisamment d√©crits." : "Ajoute URL + √©tats (initial / apr√®s clic / overlay).");

    const whereOk = els.where.value.trim() && !looksVagueSection(els.where.value,"where");
    add(whereOk ? "ok" : "bad", "O√π (cible)", whereOk ? "OK ‚Äî cible/zone identifiables." : "Pr√©cise tuiles/bloc + position exacte.");

    const whatOk = els.what.value.trim() && !looksVagueSection(els.what.value,"what");
    add(whatOk ? "ok" : "bad", "Quoi (changement)", whatOk ? "OK ‚Äî action + contenu/format." : "Donne action + texte exact ou format/formule.");

    const lim = els.limits.value.trim();
    add(lim ? "ok" : "warn", "Limites", lim ? "OK ‚Äî garde-fous pr√©sents." : "Recommand√© : charte, fond, typo, layout, interdits.");

    const needApp = q.needApp;
    const app = els.approach.value.trim();
    add(!needApp ? "ok" : (app ? "ok" : "warn"), "Approche (robustesse)",
      !needApp ? "N/A ‚Äî pas d‚Äôindice fort de dynamisme." : (app ? "OK ‚Äî dynamique cadr√©." : "Recommand√© : r√©-application + idempotence + overlays."));

    const ver = els.verify.value.trim();
    add(ver ? "ok" : "warn", "V√©rification", ver ? "OK ‚Äî crit√®res de succ√®s d√©crits." : "Optionnel : persistance apr√®s interactions, overlays, style barr√©/gris, etc.");

    els.checks.innerHTML = items.join("");
  }

  function updateUI(){
    setCounter(els.c_context, els.context.value);
    setCounter(els.c_where, els.where.value);
    setCounter(els.c_what, els.what.value);
    setCounter(els.c_limits, els.limits.value);
    setCounter(els.c_approach, els.approach.value);
    setCounter(els.c_verify, els.verify.value);

    const q = computeQuality();

    els.scorePill.textContent = `${q.score}% ${q.ready ? "‚úÖ" : "‚õî"}`;
    els.scoreBar.style.width = `${q.score}%`;

    if(q.state === "ready"){
      els.scoreBar.style.background = "linear-gradient(90deg, #22C55E, #14B8A6)";
      els.dotState.style.background = "var(--good)";
      els.stateLabel.textContent = "Prompt pr√™t";
      els.genBadge.textContent = "PBX-ready";
    } else if(q.state === "warn"){
      els.scoreBar.style.background = "linear-gradient(90deg, #F59E0B, #FBBF24)";
      els.dotState.style.background = "var(--warn)";
      els.stateLabel.textContent = "Presque pr√™t";
      els.genBadge.textContent = "Incomplet";
    } else {
      els.scoreBar.style.background = "linear-gradient(90deg, #EF4444, #F97316)";
      els.dotState.style.background = "var(--bad)";
      els.stateLabel.textContent = "Prompt incomplet";
      els.genBadge.textContent = "Incomplet";
    }

    renderChecks(q);
    els.btnGenerate.disabled = !q.ready;
    els.btnCopy.disabled = !els.result.value.trim();

    save();
    return q;
  }

  function buildQuestions(){
    // max 3 questions, cibl√©es sur Contexte/O√π/Quoi (+ Approche si dynamique)
    const qs = [];
    const add = (q, ex) => {
      if(qs.length >= 3) return;
      qs.push(`- ${q}\n  - Exemple : ${ex}`);
    };

    const ctx = els.context.value.trim();
    const whr = els.where.value.trim();
    const wht = els.what.value.trim();

    if(!ctx || looksVagueSection(ctx,"context")){
      add("Quel est le contexte exact (URL + √©tats √† couvrir : initial / apr√®s clic / overlay) ?",
          "‚ÄúURL: https://‚Ä¶ Listing. Appliquer au chargement + apr√®s clic ‚Äòvoir tout‚Äô + dans overlay ‚Äòvoir le d√©tail‚Äô.‚Äù");
    }
    if(!whr || looksVagueSection(whr,"where")){
      add("O√π exactement sur la page (cible + position) ?",
          "‚ÄúDans les tuiles iPhone 17/17 Pro/17 Pro Max, ins√©rer le message sous l‚Äôimage, centr√©.‚Äù");
    }
    if(!wht || looksVagueSection(wht,"what")){
      add("Quel changement exact (action + contenu/format) ?",
          "‚ÄúAjouter le texte EXACT ‚Äò‚Ä¶‚Äô‚Äù / ‚ÄúRemplacer la ligne au-dessus du prix par ‚Äò9,99‚Ç¨/mois‚Äô calcul√©.‚Äù");
    }

    if(qs.length < 3 && needsApproachFromContext() && !els.approach.value.trim()){
      add("Quelle approche pour le contenu dynamique (r√©-application / overlay) ?",
          "‚ÄúMutationObserver + apply() idempotent (data-processed). Relancer apr√®s ouverture/fermeture overlay.‚Äù");
    }

    if(qs.length === 0) qs.push("- Ton prompt est d√©j√† PBX-ready ‚úÖ");

    return `
üß™ Validation (anti-cr√©dits) ‚Äî questions utiles (max 3)

${qs.join("\n\n")}
`.trim();
  }

  function buildPBXPrompt(){
    const blocks = [];

    blocks.push("Front-end variation only (no back-end changes).");

    blocks.push("\nContexte :\n" + els.context.value.trim());
    blocks.push("\nO√π :\n" + els.where.value.trim());
    blocks.push("\nQuoi :\n" + els.what.value.trim());

    if(els.limits.value.trim()){
      blocks.push("\nLimites :\n" + els.limits.value.trim());
    }

    if(els.approach.value.trim()){
      blocks.push("\nApproche :\n" + els.approach.value.trim());
    } else if(needsApproachFromContext()){
      // Petit safety-net si contexte dynamique mais approche vide
      blocks.push("\nApproche :\nAppliquer au chargement + r√©appliquer lors d‚Äôajouts DOM (MutationObserver). Idempotent (pas de doublons). Fonctionner dans overlays si pr√©sents. Fallback : ne rien faire si cible introuvable.");
    }

    if(els.verify.value.trim()){
      blocks.push("\nV√©rification :\n" + els.verify.value.trim());
    }

    blocks.push("\nAttendu :\nG√©n√©rer le code robuste qui applique strictement ces r√®gles sans d√©grader le design et sans erreur console.");
    return blocks.join("\n").trim();
  }

  function validate(){
    els.result.value = buildQuestions();
    els.btnCopy.disabled = !els.result.value.trim();
    toast("Questions g√©n√©r√©es ‚úÖ");
  }

  function generate(){
    const q = updateUI();
    if(!q.ready) return;
    els.result.value = buildPBXPrompt();
    els.btnCopy.disabled = !els.result.value.trim();
    toast("Prompt g√©n√©r√© ‚úÖ");
  }

  async function copy(){
    const v = els.result.value.trim();
    if(!v) return;
    try{
      await navigator.clipboard.writeText(v);
      toast("Copi√© ‚úÖ");
    }catch(e){
      els.result.select();
      document.execCommand("copy");
      toast("Copi√© ‚úÖ");
    }
    els.btnCopy.disabled = false;
  }

  function toast(msg){
    els.toast.textContent = msg;
    els.toast.style.display = "block";
    setTimeout(()=> els.toast.style.display="none", 2000);
  }

  function save(){
    const payload = {
      context: els.context.value,
      where: els.where.value,
      what: els.what.value,
      limits: els.limits.value,
      approach: els.approach.value,
      verify: els.verify.value
    };
    try{ localStorage.setItem(SKEY, JSON.stringify(payload)); }catch(e){}
  }

  function load(){
    try{
      const raw = localStorage.getItem(SKEY);
      if(!raw) return;
      const p = JSON.parse(raw);
      if(p.context != null) els.context.value = p.context;
      if(p.where != null) els.where.value = p.where;
      if(p.what != null) els.what.value = p.what;
      if(p.limits != null) els.limits.value = p.limits;
      if(p.approach != null) els.approach.value = p.approach;
      if(p.verify != null) els.verify.value = p.verify;
    }catch(e){}
  }

  function resetAll(){
    const ok = confirm("R√©initialiser ?");
    if(!ok) return;
    els.context.value = "";
    els.where.value = "";
    els.what.value = "";
    els.limits.value = "";
    els.approach.value = "";
    els.verify.value = "";
    els.result.value = "";
    try{ localStorage.removeItem(SKEY); }catch(e){}
    updateUI();
  }

  // chips (multi-target)
  document.querySelectorAll(".chip").forEach(chip=>{
    chip.addEventListener("click", ()=>{
      const target = chip.getAttribute("data-target") || "what";
      const add = chip.getAttribute("data-add") || "";
      if(!add) return;
      const el = $(target);
      if(!el) return;
      if(!el.value.trim()) el.value = add;
      else el.value = (el.value.trim() + "\n\n" + add).trim();
      el.focus();
      updateUI();
    });
  });

  // watchers
  ["context","where","what","limits","approach","verify"].forEach(id=>{
    $(id).addEventListener("input", updateUI);
    $(id).addEventListener("change", updateUI);
  });

  // buttons
  els.btnValidate.addEventListener("click", validate);
  els.btnGenerate.addEventListener("click", generate);
  els.btnCopy.addEventListener("click", copy);
  els.btnReset.addEventListener("click", resetAll);

  // shortcut Ctrl+Enter (validate if blocked, else generate)
  document.addEventListener("keydown", (e)=>{
    const isMac = navigator.platform.toUpperCase().includes("MAC");
    const ctrl = isMac ? e.metaKey : e.ctrlKey;
    if(ctrl && e.key === "Enter"){
      e.preventDefault();
      const q = updateUI();
      if(q.ready) generate();
      else validate();
    }
  });

  // init
  load();
  updateUI();
</script>
</body>
</html>
