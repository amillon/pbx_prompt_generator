<script>
  function buildPromptSection(title, content) {
    if (!content || !content.trim()) return "";
    return title + ":\n" + content.trim() + "\n\n";
  }

  const vagueWords = ["améliorer","optimiser","faire mieux","rendre plus","augmenter","peaufiner","quelque chose","comme tu veux","à ta guise"];
  function looksVague(text) {
    if (!text) return true;
    const t = text.trim().toLowerCase();
    if (t.length < 25) return true;
    return vagueWords.some(w => t.includes(w)) && t.length < 90;
  }
  function likelyMultiObjective(text) {
    if (!text) return false;
    const t = (" " + text.toLowerCase() + " ");
    const hits = [" et ", " puis ", " en même temps ", " à la fois ", " + "]
      .reduce((acc, k) => acc + (t.split(k).length - 1), 0);
    return hits >= 4;
  }

  // Map tes champs existants -> bonnes pratiques
  function readForm() {
    return {
      // Action / tâche
      action: document.getElementById("immediateRequest").value || document.getElementById("detailedTask").value,
      // Cible + détails
      targetDetails: document.getElementById("backgroundData").value, // (tu peux garder, mais idéalement tu ajoutes un champ "élément à modifier")
      // Comportement attendu
      behavior: document.getElementById("thinkingInstructions").value,
      // Contraintes
      constraints: document.getElementById("detailedTask").value, // contient souvent règles/à éviter — sinon ajoute un champ dédié
      // Format
      format: document.getElementById("outputFormatting").value,
      // Bonus
      success: document.getElementById("taskContext").value,
      tone: document.getElementById("toneContext").value,
      examples: document.getElementById("examples").value,
      history: document.getElementById("conversationHistory").value,
      draft: document.getElementById("prefilledResponse").value,
    };
  }

  function computeQuality(data) {
    const missing = [];
    const risks = [];

    // Critiques
    if (!data.action || !data.action.trim()) missing.push("❌ Action manquante : écris ce que tu veux obtenir (livrable concret).");
    if (data.action && looksVague(data.action)) risks.push("⚠️ Action vague : évite “optimiser/améliorer”. Donne un livrable + contraintes (ex: 5 variantes de CTA, 12 mots max…).");
    if (data.action && likelyMultiObjective(data.action)) risks.push("⚠️ Plusieurs objectifs détectés : fais 1 prompt = 1 use case.");

    // Ici, ton formulaire n'a pas un champ “cible à modifier”. Tu dois le forcer d’une manière ou d’une autre.
    // À défaut, on exige une précision dans backgroundData ou detailedTask.
    const hasTargetSignal = (data.targetDetails && data.targetDetails.trim().length >= 20) ||
                            (document.getElementById("detailedTask").value || "").toLowerCase().includes("cta") ||
                            (document.getElementById("detailedTask").value || "").toLowerCase().includes("hero") ||
                            (document.getElementById("detailedTask").value || "").toLowerCase().includes("bloc");
    if (!hasTargetSignal) missing.push("❌ Cible floue : indique l’élément exact (hero/CTA/pricing/formulaire…) et où il se trouve.");

    // Contraintes : au moins une règle / un interdit
    const rulesText = (document.getElementById("detailedTask").value || "") + " " + (data.format || "");
    if (!rulesText.trim() || rulesText.trim().length < 20) missing.push("❌ Contraintes manquantes : ajoute au moins 1 règle (longueur, ton, mots interdits, accessibilité, etc.).");

    if (!data.format || !data.format.trim()) missing.push("❌ Format manquant : impose un format exploitable (tableau/JSON/markdown + champs).");

    // Recommandés
    if (!data.success || data.success.trim().length < 15) risks.push("ℹ️ Ajoute des critères de succès (KPI/objectif) pour guider l’IA.");
    if (!data.behavior || data.behavior.trim().length < 15) risks.push("ℹ️ Ajoute un comportement attendu (nombre de variantes, step-by-step, validations).");
    if (!data.examples || data.examples.trim().length < 10) risks.push("ℹ️ Ajoute 1 exemple (à suivre / à éviter) pour stabiliser la qualité.");
    
    // Score
    // Base = 100, on retire selon manques/risques (les manques pèsent lourd)
    let score = 100;
    score -= missing.length * 25;
    score -= risks.filter(r => r.startsWith("⚠️")).length * 10;
    score -= risks.filter(r => r.startsWith("ℹ️")).length * 5;
    if (score < 0) score = 0;
    if (score > 100) score = 100;

    const ready = missing.length === 0 && score >= 70;
    return { score, ready, missing, risks };
  }

  function updateQualityUI() {
    const data = readForm();
    const q = computeQuality(data);

    const scoreEl = document.getElementById("qualityScore");
    const barEl = document.getElementById("qualityBar");
    const missingEl = document.getElementById("missingList");
    const riskEl = document.getElementById("riskList");
    const btn = document.getElementById("generateBtn");

    scoreEl.textContent = q.score + "% " + (q.ready ? "✅ prêt" : "⛔ incomplet");
    barEl.style.width = q.score + "%";
    barEl.style.background = q.ready ? "#22c55e" : (q.score >= 50 ? "#f59e0b" : "#ef4444");

    missingEl.innerHTML = q.missing.length ? ("<strong>À compléter :</strong><br>" + q.missing.join("<br>")) : "";
    riskEl.innerHTML = q.risks.length ? ("<strong>À risque / recommandé :</strong><br>" + q.risks.join("<br>")) : "";

    btn.disabled = !q.ready;
    btn.style.opacity = q.ready ? "1" : "0.5";
    btn.style.cursor = q.ready ? "pointer" : "not-allowed";

    return { data, q };
  }

  // Mise à jour en live
  const watchedIds = [
    "taskContext","toneContext","backgroundData","detailedTask","examples",
    "conversationHistory","immediateRequest","thinkingInstructions","outputFormatting","prefilledResponse"
  ];
  watchedIds.forEach(id => {
    const el = document.getElementById(id);
    el.addEventListener("input", updateQualityUI);
  });

  // Génération
  document.getElementById("generateBtn").addEventListener("click", function () {
    const { data, q } = updateQualityUI();
    if (!q.ready) return; // sécurité

    const promptParts = [];

    // Prompt structuré selon les slides
    const header =
      "Tu es une IA spécialisée en Prompt-based Experimentation.\n" +
      "Objectif : produire une réponse directement exploitable, sans ambiguïté.\n" +
      "Règles :\n" +
      "- Un prompt = un use case (si plusieurs objectifs, le signaler).\n" +
      "- Ne pas deviner : si une info critique manque, poser jusqu’à 3 questions.\n" +
      "- Éviter les détails back-end non nécessaires.\n\n";

    promptParts.push(header);

    promptParts.push(buildPromptSection("1) Une tâche / action (ce que tu dois faire)", data.action));
    promptParts.push(buildPromptSection("2) Cible + détails (élément à modifier + détails visuels/texte)", data.targetDetails));
    promptParts.push(buildPromptSection("3) Comportement attendu (step-by-step, itérations, vérifs)", data.behavior));
    promptParts.push(buildPromptSection("4) Contraintes (limitations, exigences, éléments à éviter)", document.getElementById("detailedTask").value));

    // Bonus : contexte / ton / exemples / format / brouillon
    promptParts.push(buildPromptSection("Contexte utile", data.success));
    promptParts.push(buildPromptSection("Ton & style", data.tone));
    promptParts.push(buildPromptSection("Exemples (à suivre / à éviter)", data.examples));
    promptParts.push(buildPromptSection("Format de sortie", data.format));
    promptParts.push(buildPromptSection("Brouillon à retravailler (si présent)", data.draft));
    promptParts.push(buildPromptSection("Historique pertinent (si présent)", data.history));

    const finalPrompt = promptParts.join("").trim();
    document.getElementById("result").value = finalPrompt;
    document.getElementById("status").style.display = "none";
  });

  document.getElementById("copyBtn").addEventListener("click", function () {
    const result = document.getElementById("result");
    if (!result.value.trim()) return;

    result.select();
    result.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(result.value).then(function () {
      const status = document.getElementById("status");
      status.textContent = "Prompt copié !";
      status.style.display = "inline";
      setTimeout(() => { status.style.display = "none"; }, 2000);
    });
  });

  // init
  updateQualityUI();
</script>
