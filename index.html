<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PBX Prompt Builder ‚Äî Formulaire (Contexte / Quand / O√π / Quoi / Limites / Approche)</title>
  <style>
    :root{
      --bg:#F6F7FB;
      --card:#FFFFFF;
      --ink:#0F172A;
      --muted:#64748B;
      --muted2:#94A3B8;
      --line:#E2E8F0;

      --primary:#6D28D9;
      --teal:#14B8A6;

      --good:#22C55E;
      --warn:#F59E0B;
      --bad:#EF4444;

      --shadow2: 0 10px 26px rgba(15, 23, 42, 0.07);
      --r:18px;
    }

    *{ box-sizing:border-box; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", sans-serif; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 520px at 15% -10%, rgba(109,40,217,0.16), transparent 55%),
        radial-gradient(1200px 520px at 85% -10%, rgba(20,184,166,0.14), transparent 55%),
        var(--bg);
      color:var(--ink);
      min-height:100vh;
      padding: 20px 14px 46px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }

    .wrap{ width:100%; max-width: 1200px; }

    /* Header */
    .top{
      display:flex;
      gap:14px;
      justify-content:space-between;
      align-items:flex-start;
      flex-wrap:wrap;
      margin-bottom: 14px;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:flex-start;
      min-width: 280px;
      flex: 1 1 740px;
    }
    .logo{
      width:44px; height:44px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--primary), var(--teal));
      box-shadow: var(--shadow2);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:950;
      letter-spacing:-0.3px;
      flex-shrink:0;
    }
    h1{ margin:0; font-size: 22px; letter-spacing:-0.2px; line-height:1.2; }
    .sub{
      margin:5px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height:1.35;
      max-width: 960px;
    }

    .metaPills{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      flex: 1 1 360px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,0.88);
      box-shadow: 0 10px 22px rgba(15,23,42,0.05);
      font-size: 12.5px;
      color: var(--muted);
      white-space:nowrap;
    }
    .dot{ width:9px; height:9px; border-radius:999px; background: var(--muted2); }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1fr 380px;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 1020px){
      .grid{ grid-template-columns: 1fr; }
      .side{ position: static !important; }
    }

    .card{
      background: rgba(255,255,255,0.92);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow2);
    }
    .card .inner{ padding: 16px; }

    /* Form blocks */
    .hero{
      border: 1px solid var(--line);
      border-radius: 18px;
      background: rgba(255,255,255,0.78);
      padding: 14px;
      margin-bottom: 12px;
    }
    .heroHead{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .heroLeft{ display:flex; gap:10px; align-items:flex-start; }
    .heroIcon{
      width:36px; height:36px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(109,40,217,0.12), rgba(20,184,166,0.12));
      border: 1px solid rgba(109,40,217,0.18);
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--primary);
      font-weight: 950;
      flex-shrink:0;
    }
    .heroTitle{ margin:0; font-size: 14px; font-weight: 950; letter-spacing:-0.15px; }
    .heroDesc{ margin:3px 0 0; font-size: 12.5px; color: var(--muted); line-height:1.35; }

    .tags{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .tag{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--muted);
      white-space:nowrap;
    }
    .tag.req{
      border-color: rgba(239,68,68,0.22);
      background: rgba(239,68,68,0.06);
      color: #991B1B;
      font-weight: 900;
    }

    textarea{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(248,250,252,0.85);
      padding: 11px 12px;
      font-size: 13.8px;
      outline:none;
      transition: border-color .15s, box-shadow .15s, background .15s;
      line-height: 1.35;
      min-height: 120px;
      resize: vertical;
    }
    textarea:focus{
      border-color: rgba(109,40,217,0.55);
      box-shadow: 0 0 0 3px rgba(109,40,217,0.18);
      background: #fff;
    }
    textarea[disabled]{
      opacity:.75;
      cursor:not-allowed;
      background: rgba(248,250,252,0.55);
    }

    .hint{
      margin-top: 10px;
      padding: 10px 11px;
      border-radius: 14px;
      border: 1px dashed rgba(100,116,139,0.24);
      background: rgba(2,6,23,0.03);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .hint strong{ color: var(--ink); }

    /* chips */
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top: 10px;
    }
    .chip{
      border: 1px solid var(--line);
      background: #fff;
      color: var(--ink);
      font-weight: 900;
      font-size: 12.5px;
      padding: 8px 10px;
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 8px 18px rgba(15,23,42,0.04);
      transition: transform .06s ease, border-color .15s ease, background .15s ease;
    }
    .chip:active{ transform: translateY(1px); }
    .chip:hover{ border-color: rgba(109,40,217,0.35); }
    .chip.active{
      border-color: rgba(109,40,217,0.55);
      background: rgba(109,40,217,0.08);
      box-shadow: 0 10px 22px rgba(109,40,217,0.10);
    }

    /* Sidebar */
    .side{ position: sticky; top: 14px; }

    .qTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom: 10px;
    }
    .qTop h3{
      margin:0;
      font-size: 14px;
      font-weight: 950;
      letter-spacing:-0.15px;
    }
    .scorePill{
      font-size: 12.5px;
      font-weight: 950;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--muted);
      white-space:nowrap;
    }
    .bar{
      height: 10px;
      background: #E2E8F0;
      border-radius: 999px;
      overflow:hidden;
      margin-bottom: 10px;
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: var(--good);
      transition: width .2s ease, background .2s ease;
    }

    .checks{
      display:grid;
      gap:10px;
      margin-top: 10px;
    }
    .item{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.86);
    }
    .ico{
      width:26px; height:26px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight: 950;
      flex-shrink:0;
      background: var(--muted2);
    }
    .item.ok .ico{ background: var(--good); }
    .item.warn .ico{ background: var(--warn); }
    .item.bad .ico{ background: var(--bad); }
    .itT{ margin:0; font-size: 12.6px; font-weight: 950; letter-spacing:-0.1px; }

    .divider{ margin: 12px 0; height: 1px; background: var(--line); }

    /* Sidebar actions */
    .actions{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 12px;
    }
    .btn{
      border: none;
      border-radius: 16px;
      padding: 11px 12px;
      font-size: 13.7px;
      font-weight: 950;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
      transition: transform .06s ease, opacity .15s ease, box-shadow .15s ease;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, var(--primary), var(--teal));
      color:#fff;
      box-shadow: 0 14px 30px rgba(109,40,217,0.20);
    }
    .btn.ghost{
      background: #fff;
      border: 1px solid var(--line);
      color: var(--ink);
    }
    .btn.danger{
      background: rgba(239,68,68,0.08);
      border: 1px solid rgba(239,68,68,0.22);
      color: #991B1B;
    }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; box-shadow:none; }

    /* Result */
    .resultHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 8px;
    }
    .resultHead h3{
      margin:0;
      font-size: 14px;
      font-weight: 950;
      letter-spacing:-0.15px;
    }
    .badge{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--muted);
      white-space:nowrap;
    }
    #result{
      width:100%;
      min-height: 240px;
      border-radius: 16px;
      border: none;
      outline:none;
      padding: 12px 12px;
      background: #020617;
      color: #E5E7EB;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12.8px;
      line-height: 1.45;
      white-space: pre-wrap;
    }
    .toast{
      display:none;
      margin-top: 8px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(34,197,94,0.25);
      background: rgba(34,197,94,0.08);
      color: #14532D;
      font-weight: 950;
      font-size: 12.5px;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">PBX</div>
        <div>
          <h1>PBX Prompt Generator</h1>
          <p class="sub">Objectif : produire un prompt PBX <strong>robuste</strong> pr√™t √† l'utilisation.</p>
        </div>
      </div>

      <div class="metaPills">
        <div class="pill"><span class="dot" id="dotState"></span><span id="stateLabel">Prompt incomplet</span></div>
      </div>
    </div>

    <div class="grid">
      <!-- MAIN -->
      <div>
        <div class="card">
          <div class="inner">

            <!-- Contexte -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">‚ë†</div>
                  <div>
                    <p class="heroTitle">Contexte</p>
                    <p class="heroDesc"><strong>√Ä indiquer :</strong> le contexte de votre variante (ex : ‚Äúje veux modifier les tuiles iPhone‚Äù).</p>
                  </div>
                </div>
                <div class="tags"><span class="tag req">Obligatoire</span></div>
              </div>
              <textarea id="context" placeholder="Ex : Je souhaite une variante qui me permet de mettre en avant le prix / ajouter un message promo / clarifier une information."></textarea>
              <div class="hint"><strong>Astuce :</strong> restez macro, le d√©tail viendra dans les sections suivantes.</div>
            </div>

            <!-- Quand appliquer -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">‚ë°</div>
                  <div>
                    <p class="heroTitle">Quand appliquer la variation ?</p>
                    <p class="heroDesc"><strong>√Ä renseigner :</strong> URL + type de page + quand √ßa s‚Äôapplique (chargement / apr√®s clic / overlay).</p>
                  </div>
                </div>
                <div class="tags"><span class="tag req">Obligatoire</span></div>
              </div>
              <textarea id="when" placeholder="Ex : URL: https://‚Ä¶ (listing). Appliquer au chargement + apr√®s clic ‚Äúvoir tout‚Äù + dans l‚Äôoverlay ‚Äúvoir le d√©tail‚Äù."></textarea>
              <div class="hint"><strong>Astuce :</strong> si c‚Äôest dynamique, √©cris-le (overlay / lazy-load / voir tout).</div>
            </div>

            <!-- O√π -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">‚ë¢</div>
                  <div>
                    <p class="heroTitle">O√π ?</p>
                    <p class="heroDesc"><strong>√Ä indiquer :</strong> l‚Äô√©l√©ment concern√© et sa position pr√©cise sur la page (rep√®res visuels).</p>
                  </div>
                </div>
                <div class="tags"><span class="tag req">Obligatoire</span></div>
              </div>
              <textarea id="where" placeholder="Ex : Dans les tuiles iPhone 17/17 Pro/17 Pro Max, sous l‚Äôimage du t√©l√©phone, centr√©."></textarea>
            </div>

            <!-- Quoi ‚Äî Action -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">‚ë£</div>
                  <div>
                    <p class="heroTitle">Quoi ? ‚Äî Action</p>
                    <p class="heroDesc"><strong>√Ä indiquer :</strong> que voulez-vous faire ? (Ajouter / Remplacer / Supprimer / D√©placer / ‚Ä¶)</p>
                  </div>
                </div>
                <div class="tags"><span class="tag req">Obligatoire</span></div>
              </div>

              <input id="action" type="hidden" value="" />
              <div class="chips" id="actionChips" aria-label="Actions">
                <div class="chip" data-action="Ajouter">Ajouter</div>
                <div class="chip" data-action="Remplacer">Remplacer</div>
                <div class="chip" data-action="Supprimer">Supprimer</div>
                <div class="chip" data-action="D√©placer">D√©placer</div>
                <div class="chip" data-action="Calculer">Calculer</div>
                <div class="chip" data-action="Afficher">Afficher</div>
                <div class="chip" data-action="Mettre en avant">Mettre en avant</div>
                <div class="chip" data-action="Restyler">Restyler</div>
              </div>

              <div class="hint">
                <strong>Plusieurs actions ?</strong> OK ‚Äî s√©lectionne-les, puis <strong>num√©rote-les</strong> dans ‚ÄúContenu‚Äù (1., 2., 3.).
              </div>

              <div style="margin-top:12px"></div>

              <!-- Quoi ‚Äî Contenu -->
              <div class="heroHead" style="margin-bottom:6px">
                <div class="heroLeft">
                  <div class="heroIcon">‚ë§</div>
                  <div>
                    <p class="heroTitle">Quoi ? ‚Äî Contenu</p>
                    <p class="heroDesc"><strong>√Ä indiquer :</strong> d√©crivez l‚Äôaction (texte exact ou format ou formule).</p>
                  </div>
                </div>
              </div>

              <textarea id="content" placeholder="S√©lectionne d‚Äôabord une action." disabled></textarea>

              <div class="hint">
                <strong>Exemple multi-actions :</strong><br>
                1. Supprimer le bloc ‚ÄúX‚Äù<br>
                2. Ajouter le texte ‚Äúabc‚Äù sous l‚Äôimage, centr√©
              </div>
            </div>

            <!-- Limites -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">‚ë•</div>
                  <div>
                    <p class="heroTitle">Limites</p>
                    <p class="heroDesc"><strong>√Ä indiquer :</strong> ce qui ne doit pas bouger (layout ou typo ou couleurs) et les interdits.</p>
                  </div>
                </div>
                <div class="tags"><span class="tag">Recommand√©</span></div>
              </div>
              <textarea id="limits" placeholder="Ex : Ne pas modifier la grille/layout. Respecter fond greige + typographie."></textarea>
            </div>

            <!-- Approche -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">‚ë¶</div>
                  <div>
                    <p class="heroTitle">Approche</p>
                    <p class="heroDesc"><strong>√Ä indiquer :</strong> comment √ßa tient si la page est dynamique (MutationObserver ou events) et √©viter les doublons.</p>
                  </div>
                </div>
                <div class="tags"><span class="tag">Recommand√©</span></div>
              </div>
              <textarea id="approach" placeholder="Ex : Appliquer au chargement + r√©appliquer sur ajouts DOM. Idempotent (data-processed). Fallback safe."></textarea>
            </div>

            <!-- V√©rification -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">‚ëß</div>
                  <div>
                    <p class="heroTitle">V√©rification attendue</p>
                    <p class="heroDesc"><strong>√Ä indiquer :</strong> comment on v√©rifie visuellement (persistant / overlay OK / style barr√©/gris‚Ä¶).</p>
                  </div>
                </div>
                <div class="tags"><span class="tag">Optionnel</span></div>
              </div>
              <textarea id="verify" placeholder="Ex : Le texte reste apr√®s interactions. Visible dans overlay. Si prix calcul√© : barr√© + gris partout."></textarea>
            </div>

          </div>
        </div>
      </div>

      <!-- SIDEBAR -->
      <div class="side">
        <div class="card">
          <div class="inner">
            <div class="qTop">
              <h3>Contr√¥le qualit√©</h3>
              <div class="scorePill" id="scorePill">0% ‚õî</div>
            </div>
            <div class="bar"><div id="scoreBar"></div></div>

            <div class="checks" id="checks"></div>

            <div class="actions">
              <button class="btn primary" id="btnGenerate" type="button">‚öôÔ∏è G√©n√©rer le prompt</button>
              <button class="btn ghost" id="btnCopy" type="button" disabled>üìã Copier</button>
              <button class="btn danger" id="btnReset" type="button">üóëÔ∏è R√©initialiser</button>
            </div>

            <div class="divider"></div>

            <div class="resultHead">
              <h3>Prompt PBX pr√™t √† coller</h3>
              <span class="badge" id="genBadge">Incomplet</span>
            </div>
            <textarea id="result" readonly placeholder="Clique ‚ÄúG√©n√©rer le prompt‚Äù."></textarea>
            <div class="toast" id="toast">Copi√© ‚úÖ</div>

          </div>
        </div>
      </div>

    </div>
  </div>

<script>
  console.log("[DEBUG] PBX_FORM_SCRIPT_V7");

  const $ = (id) => document.getElementById(id);
  const on = (el, evt, fn) => { if (el) el.addEventListener(evt, fn); };

  function RX(pattern, flags = "i") {
    try { return new RegExp(pattern, flags); } catch { return null; }
  }
  function testRX(re, value) {
    if (!re) return false;
    try { return re.test(value); } catch { return false; }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const SKEY = "pbx_prompt_form_v7";

    const els = {
      context: $("context"),
      when: $("when"),
      where: $("where"),
      action: $("action"),          // hidden
      actionChips: $("actionChips"),
      content: $("content"),
      limits: $("limits"),
      approach: $("approach"),
      verify: $("verify"),

      result: $("result"),
      toast: $("toast"),

      btnGenerate: $("btnGenerate"),
      btnCopy: $("btnCopy"),
      btnReset: $("btnReset"),

      scorePill: $("scorePill"),
      scoreBar: $("scoreBar"),
      checks: $("checks"),

      dotState: $("dotState"),
      stateLabel: $("stateLabel"),
      genBadge: $("genBadge"),
    };

    const reHasUrl = RX("(https?:\\/\\/|www\\.)");
    const reHasDyn = RX("(overlay|modal|voir tout|voir le d√©tail|pagination|filtre|lazy|dynamique|ajax|infinite|scroll)");
    const reWhenHasTrigger = RX("(chargement|initial|apr√®s clic|apres clic|after click|overlay|modal|voir tout|voir le d√©tail|lazy|dynamique|ajax|scroll)", "i");
    const reWhereHints = RX("(tuile|carte|bloc|section|bouton|cta|prix|image|h1|titre|ligne|au-dessus|en dessous|sous|centr√©|droite|gauche|overlay|modal|listing)");
    const reWhereSpecific = RX('(["‚Äú‚Äù\\\']|\\b(iPhone|forfait|‚Ç¨\\/mois|prix)\\b)');
    const reContentConcrete = RX('(["‚Äú‚Äù\\\']|\\b\\d+([,.]\\d+)?\\b|‚Ç¨|\\/mois|format|formule|calcul)');
    const reNumbered = RX("^\\s*\\d+\\.", "m");

    const vagueMarkers = [
      "am√©liorer","optimiser","faire mieux","rendre plus","peaufiner","comme tu veux","√† ta guise","peu importe",
      "make it better","optimize","improve"
    ];

    const ACTIONS = [
      "Ajouter","Remplacer","Supprimer","D√©placer","Calculer","Afficher","Mettre en avant","Restyler"
    ];

    function getSelectedActions(){
      const selected = [];
      document.querySelectorAll("#actionChips .chip.active[data-action]").forEach(c=>{
        const a = (c.getAttribute("data-action") || "").trim();
        if(a) selected.push(a);
      });
      return selected;
    }

    function needsApproachFromText(){
      const t = `${els.when?.value || ""} ${els.context?.value || ""} ${els.where?.value || ""}`.toLowerCase();
      return testRX(reHasDyn, t);
    }

    function looksVagueSection(text, kind){
      const t = (text || "").trim();
      if(!t) return true;
      const low = t.toLowerCase();
      const hasVague = vagueMarkers.some(m => low.includes(m));

      if(kind === "context"){
        if(t.length < 15) return true;
        if(hasVague && t.length < 25) return true;
        return false;
      }

      if(kind === "when"){
        const hasUrl = testRX(reHasUrl, t);
        const hasTrigger = testRX(reWhenHasTrigger, t);
        if(t.length < 18) return true;
        if(!hasUrl && !hasTrigger) return true;
        if(hasVague && !hasUrl) return true;
        return false;
      }

      if(kind === "where"){
        const hasHint = testRX(reWhereHints, t);
        const hasSpecific = testRX(reWhereSpecific, t);
        if(t.length < 14) return true;
        if(!hasHint && !hasSpecific) return true;
        if(hasVague && !hasHint) return true;
        return false;
      }

      if(kind === "content"){
        const hasConcrete = testRX(reContentConcrete, t);
        if(t.length < 8) return true;
        if(hasVague && !hasConcrete) return true;
        if(!hasConcrete) return true;
        return false;
      }

      if(kind === "limits"){ return t.length < 10; }
      if(kind === "approach"){ return t.length < 10; }
      return false;
    }

    function computeQuality(){
      const ctx = (els.context?.value || "").trim();
      const whn = (els.when?.value || "").trim();
      const whr = (els.where?.value || "").trim();
      const actions = getSelectedActions();
      const cnt = (els.content?.value || "").trim();
      const lim = (els.limits?.value || "").trim();
      const app = (els.approach?.value || "").trim();

      const needApp = needsApproachFromText();

      // multi-actions => contenu num√©rot√©
      const requiresNumbering = actions.length > 1;
      const hasNumbering = testRX(reNumbered, cnt);

      const ok = {
        context: !!ctx && !looksVagueSection(ctx,"context"),
        when:    !!whn && !looksVagueSection(whn,"when"),
        where:   !!whr && !looksVagueSection(whr,"where"),
        action:  actions.length >= 1,
        content: !!cnt && !looksVagueSection(cnt,"content") && (!requiresNumbering || hasNumbering),
        limits:  !!lim && !looksVagueSection(lim,"limits"),
        approach: !!app && !looksVagueSection(app,"approach"),
      };

      // score progressif
      // 5 obligatoires = 80 (16 chacun)
      // limites = +10
      // approche = +10 si dynamique, sinon +5
      let score = 0;
      score += ok.context ? 16 : 0;
      score += ok.when    ? 16 : 0;
      score += ok.where   ? 16 : 0;
      score += ok.action  ? 16 : 0;
      score += ok.content ? 16 : 0;

      score += ok.limits ? 10 : 0;
      score += needApp ? (ok.approach ? 10 : 0) : (ok.approach ? 5 : 0);

      score = Math.max(0, Math.min(100, score));

      // readiness (strict)
      const ready = ok.context && ok.when && ok.where && ok.action && ok.content && score >= 70;
      const state = ready ? "ready" : (score >= 50 ? "warn" : "bad");

      // sync hidden action value
      if (els.action) els.action.value = actions.join("\n");

      return { score, ready, state, needApp, ok, requiresNumbering, actions };
    }

    function renderChecks(q){
      if(!els.checks) return;

      const makeItem = (state, title) => {
        const icon = state === "ok" ? "‚úì" : (state === "warn" ? "!" : "√ó");
        return `
          <div class="item ${state}">
            <div class="ico">${icon}</div>
            <div><p class="itT">${title}</p></div>
          </div>
        `;
      };

      const items = [];
      items.push(makeItem(q.ok.context ? "ok" : "bad", "Contexte"));
      items.push(makeItem(q.ok.when    ? "ok" : "bad", "Quand appliquer"));
      items.push(makeItem(q.ok.where   ? "ok" : "bad", "O√π (√©l√©ment + position)"));
      items.push(makeItem(q.ok.action  ? "ok" : "bad", "Quoi ‚Äî Action"));
      items.push(makeItem(q.ok.content ? "ok" : "bad", q.requiresNumbering ? "Quoi ‚Äî Contenu (num√©rot√©)" : "Quoi ‚Äî Contenu"));

      items.push(makeItem(q.ok.limits ? "ok" : "warn", "Limites"));
      items.push(makeItem(q.needApp ? (q.ok.approach ? "ok" : "warn") : (q.ok.approach ? "ok" : "warn"),
        q.needApp ? "Approche" : "Approche (optionnel)"));

      els.checks.innerHTML = items.join("");
    }

    function updateUI(){
      const q = computeQuality();

      els.scorePill.textContent = `${q.score}% ${q.ready ? "‚úÖ" : "‚õî"}`;
      els.scoreBar.style.width = `${q.score}%`;

      if (els.dotState) els.dotState.style.background = q.state === "ready" ? "var(--good)" : (q.state === "warn" ? "var(--warn)" : "var(--bad)");
      if (els.stateLabel) els.stateLabel.textContent = q.state === "ready" ? "Prompt pr√™t" : (q.state === "warn" ? "Presque pr√™t" : "Prompt incomplet");
      if (els.genBadge) els.genBadge.textContent = q.ready ? "PBX-ready" : "Incomplet";

      renderChecks(q);

      // contenu activ√© uniquement si action s√©lectionn√©e
      if (els.content){
        if (q.actions.length === 0){
          els.content.disabled = true;
          if (!els.content.value.trim()) els.content.placeholder = "S√©lectionne d‚Äôabord une action.";
        } else {
          els.content.disabled = false;
          if (q.actions.length > 1 && !els.content.value.trim()){
            els.content.placeholder = `Num√©rote tes actions :
1. ...
2. ...`;
          } else if (els.content.placeholder.includes("S√©lectionne d‚Äôabord")) {
            els.content.placeholder = "D√©cris l‚Äôaction : texte exact / format / formule.";
          }
        }
      }

      try{
        localStorage.setItem(SKEY, JSON.stringify({
          context: els.context?.value || "",
          when: els.when?.value || "",
          where: els.where?.value || "",
          actions: q.actions || [],
          content: els.content?.value || "",
          limits: els.limits?.value || "",
          approach: els.approach?.value || "",
          verify: els.verify?.value || ""
        }));
      }catch(e){}

      return q;
    }

    function buildPBXPrompt(){
      const blocks = [];
      blocks.push("Front-end variation only (no back-end changes).");
      blocks.push("\nContexte :\n" + (els.context?.value || "").trim());
      blocks.push("\nQuand appliquer :\n" + (els.when?.value || "").trim());
      blocks.push("\nO√π :\n" + (els.where?.value || "").trim());

      const actions = getSelectedActions();
      if (actions.length > 1) {
        blocks.push("\nActions :\n" + actions.map((a,i)=>`${i+1}. ${a}`).join("\n"));
      } else {
        blocks.push("\nAction :\n" + (actions[0] || "").trim());
      }

      blocks.push("\nContenu :\n" + (els.content?.value || "").trim());
      if((els.limits?.value || "").trim()) blocks.push("\nLimites :\n" + els.limits.value.trim());
      if((els.approach?.value || "").trim()) blocks.push("\nApproche :\n" + els.approach.value.trim());
      if((els.verify?.value || "").trim()) blocks.push("\nV√©rification :\n" + els.verify.value.trim());

      blocks.push("\nAttendu :\nG√©n√®re un script robuste qui :\n1) d√©tecte les √©l√©ments cibles\n2) applique la/les action(s) exactement comme d√©crit\n3) reste stable apr√®s interactions (open/close overlays, ‚Äúvoir tout‚Äù)\n4) n‚Äôalt√®re pas la mise en page ni la charte.\n5) s'appuie sur la charte graphique de la page");
      return blocks.join("\n").trim();
    }

    function buildMissingPreview(){
      return "Compl√®te les sections marqu√©es d‚Äôune croix pour devenir PBX-ready.";
    }

    function toast(msg){
      if(!els.toast) return;
      els.toast.textContent = msg;
      els.toast.style.display = "block";
      setTimeout(()=> els.toast.style.display="none", 1200);
    }

    function generate(){
      const q = updateUI();
      if(!els.result) return;
      els.result.value = q.ready ? buildPBXPrompt() : buildMissingPreview();
      els.btnCopy.disabled = !els.result.value.trim();
      toast(q.ready ? "Prompt g√©n√©r√© ‚úÖ" : "√Ä compl√©ter ‚ö†Ô∏è");
    }

    async function copy(){
      const v = (els.result?.value || "").trim();
      if(!v) return;
      try{
        await navigator.clipboard.writeText(v);
        toast("Copi√© ‚úÖ");
      }catch(e){
        els.result?.select?.();
        document.execCommand("copy");
        toast("Copi√© ‚úÖ");
      }
    }

    function resetAll(){
      const ok = confirm("R√©initialiser ?");
      if(!ok) return;

      ["context","when","where","content","limits","approach","verify"].forEach(k => {
        if(els[k]) els[k].value = "";
      });

      document.querySelectorAll("#actionChips .chip").forEach(c => c.classList.remove("active"));
      if (els.action) els.action.value = "";

      if(els.result) els.result.value = "";
      els.btnCopy.disabled = true;

      try{ localStorage.removeItem(SKEY); }catch(e){}
      updateUI();
      toast("R√©initialis√© ‚úÖ");
    }

    // Inputs
    ["context","when","where","content","limits","approach","verify"].forEach(id=>{
      const el = $(id);
      on(el, "input", updateUI);
      on(el, "change", updateUI);
    });

    // Action chips = multi-select toggle
    document.querySelectorAll("#actionChips .chip[data-action]").forEach(chip => {
      chip.addEventListener("click", () => {
        chip.classList.toggle("active");
        updateUI();
        if (els.content && !els.content.disabled) els.content.focus();
      });
    });

    // CTAs
    on(els.btnGenerate, "click", generate);
    on(els.btnCopy, "click", copy);
    on(els.btnReset, "click", resetAll);

    // restore
    try{
      const raw = localStorage.getItem(SKEY);
      if(raw){
        const p = JSON.parse(raw);
        if(els.context && p.context != null) els.context.value = p.context;
        if(els.when && p.when != null) els.when.value = p.when;
        if(els.where && p.where != null) els.where.value = p.where;
        if(els.content && p.content != null) els.content.value = p.content;
        if(els.limits && p.limits != null) els.limits.value = p.limits;
        if(els.approach && p.approach != null) els.approach.value = p.approach;
        if(els.verify && p.verify != null) els.verify.value = p.verify;

        const savedActions = Array.isArray(p.actions) ? p.actions : [];
        if (savedActions.length){
          document.querySelectorAll("#actionChips .chip[data-action]").forEach(c=>{
            const a = (c.getAttribute("data-action") || "").trim();
            if (savedActions.includes(a)) c.classList.add("active");
          });
        }
      }
    }catch(e){}

    updateUI();
  });
</script>
</body>
</html>
