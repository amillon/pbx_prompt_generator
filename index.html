<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PBX Prompt Builder ‚Äî Formulaire (Contexte / O√π / Quoi / Limites / Approche)</title>
  <style>
    :root{
      --bg:#F6F7FB;
      --card:#FFFFFF;
      --ink:#0F172A;
      --muted:#64748B;
      --muted2:#94A3B8;
      --line:#E2E8F0;

      --primary:#6D28D9;
      --teal:#14B8A6;

      --good:#22C55E;
      --warn:#F59E0B;
      --bad:#EF4444;

      --shadow2: 0 10px 26px rgba(15, 23, 42, 0.07);
      --r:18px;
    }

    *{ box-sizing:border-box; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", sans-serif; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 520px at 15% -10%, rgba(109,40,217,0.16), transparent 55%),
        radial-gradient(1200px 520px at 85% -10%, rgba(20,184,166,0.14), transparent 55%),
        var(--bg);
      color:var(--ink);
      min-height:100vh;
      padding: 20px 14px 46px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }

    .wrap{ width:100%; max-width: 1200px; }

    /* Header */
    .top{
      display:flex;
      gap:14px;
      justify-content:space-between;
      align-items:flex-start;
      flex-wrap:wrap;
      margin-bottom: 14px;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:flex-start;
      min-width: 280px;
      flex: 1 1 740px;
    }
    .logo{
      width:44px; height:44px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--primary), var(--teal));
      box-shadow: var(--shadow2);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:950;
      letter-spacing:-0.3px;
      flex-shrink:0;
    }
    h1{ margin:0; font-size: 22px; letter-spacing:-0.2px; line-height:1.2; }
    .sub{
      margin:5px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height:1.35;
      max-width: 960px;
    }

    .metaPills{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      flex: 1 1 360px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,0.88);
      box-shadow: 0 10px 22px rgba(15,23,42,0.05);
      font-size: 12.5px;
      color: var(--muted);
      white-space:nowrap;
    }
    .dot{ width:9px; height:9px; border-radius:999px; background: var(--muted2); }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1fr 380px;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 1020px){
      .grid{ grid-template-columns: 1fr; }
      .side{ position: static !important; }
    }

    .card{
      background: rgba(255,255,255,0.92);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow2);
    }
    .card .inner{ padding: 16px; }

    /* Form blocks */
    .hero{
      border: 1px solid var(--line);
      border-radius: 18px;
      background: rgba(255,255,255,0.78);
      padding: 14px;
      margin-bottom: 12px;
    }
    .heroHead{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .heroLeft{ display:flex; gap:10px; align-items:flex-start; }
    .heroIcon{
      width:36px; height:36px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(109,40,217,0.12), rgba(20,184,166,0.12));
      border: 1px solid rgba(109,40,217,0.18);
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--primary);
      font-weight: 950;
      flex-shrink:0;
    }
    .heroTitle{ margin:0; font-size: 14px; font-weight: 950; letter-spacing:-0.15px; }
    .heroDesc{ margin:3px 0 0; font-size: 12.5px; color: var(--muted); line-height:1.35; }

    .tags{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .tag{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--muted);
      white-space:nowrap;
    }
    .tag.req{
      border-color: rgba(239,68,68,0.22);
      background: rgba(239,68,68,0.06);
      color: #991B1B;
      font-weight: 900;
    }

    .label{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin: 10px 0 6px;
    }
    .label span{ font-size: 12.7px; font-weight: 950; letter-spacing:-0.1px; }
    .counter{ font-size: 11.7px; color: var(--muted2); white-space:nowrap; }

    textarea{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(248,250,252,0.85);
      padding: 11px 12px;
      font-size: 13.8px;
      outline:none;
      transition: border-color .15s, box-shadow .15s, background .15s;
      line-height: 1.35;
      min-height: 120px;
      resize: vertical;
    }
    textarea:focus{
      border-color: rgba(109,40,217,0.55);
      box-shadow: 0 0 0 3px rgba(109,40,217,0.18);
      background: #fff;
    }

    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 860px){ .row2{ grid-template-columns: 1fr; } }

    .hint{
      margin-top: 10px;
      padding: 10px 11px;
      border-radius: 14px;
      border: 1px dashed rgba(100,116,139,0.24);
      background: rgba(2,6,23,0.03);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .hint strong{ color: var(--ink); }

    /* Sidebar */
    .side{ position: sticky; top: 14px; }

    .qTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom: 10px;
    }
    .qTop h3{
      margin:0;
      font-size: 14px;
      font-weight: 950;
      letter-spacing:-0.15px;
    }
    .scorePill{
      font-size: 12.5px;
      font-weight: 950;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--muted);
      white-space:nowrap;
    }
    .bar{
      height: 10px;
      background: #E2E8F0;
      border-radius: 999px;
      overflow:hidden;
      margin-bottom: 10px;
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: var(--good);
      transition: width .2s ease, background .2s ease;
    }

    .explain{
      margin-top: 10px;
      padding: 10px 11px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.86);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .explain strong{ color: var(--ink); }

    .checks{
      display:grid;
      gap:10px;
      margin-top: 10px;
    }
    .item{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.86);
    }
    .ico{
      width:26px; height:26px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight: 950;
      flex-shrink:0;
      background: var(--muted2);
    }
    .item.ok .ico{ background: var(--good); }
    .item.warn .ico{ background: var(--warn); }
    .item.bad .ico{ background: var(--bad); }

    .itT{ margin:0; font-size: 12.6px; font-weight: 950; letter-spacing:-0.1px; }
    .itD{ margin: 2px 0 0; font-size: 12px; color: var(--muted); line-height:1.35; }

    .divider{ margin: 12px 0; height: 1px; background: var(--line); }

    /* Sidebar actions (keep only these 3) */
    .actions{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 12px;
    }
    .btn{
      border: none;
      border-radius: 16px;
      padding: 11px 12px;
      font-size: 13.7px;
      font-weight: 950;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
      transition: transform .06s ease, opacity .15s ease, box-shadow .15s ease;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, var(--primary), var(--teal));
      color:#fff;
      box-shadow: 0 14px 30px rgba(109,40,217,0.20);
    }
    .btn.ghost{
      background: #fff;
      border: 1px solid var(--line);
      color: var(--ink);
    }
    .btn.danger{
      background: rgba(239,68,68,0.08);
      border: 1px solid rgba(239,68,68,0.22);
      color: #991B1B;
    }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; box-shadow:none; }

    /* Result */
    .resultHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 8px;
    }
    .resultHead h3{
      margin:0;
      font-size: 14px;
      font-weight: 950;
      letter-spacing:-0.15px;
    }
    .badge{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--muted);
      white-space:nowrap;
    }
    #result{
      width:100%;
      min-height: 240px;
      border-radius: 16px;
      border: none;
      outline:none;
      padding: 12px 12px;
      background: #020617;
      color: #E5E7EB;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12.8px;
      line-height: 1.45;
      white-space: pre-wrap;
    }
    .toast{
      display:none;
      margin-top: 8px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(34,197,94,0.25);
      background: rgba(34,197,94,0.08);
      color: #14532D;
      font-weight: 950;
      font-size: 12.5px;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">PBX</div>
        <div>
          <h1>PBX Prompt Builder ‚Äî Formulaire</h1>
          <p class="sub">
            Objectif : produire un prompt PBX <strong>r√©plicable</strong> et <strong>robuste</strong> (Contexte / O√π / Quoi / Limites / Approche).
            Le contr√¥le qualit√© explique <strong>ce qui manque</strong> pour √™tre ‚ÄúPBX-ready‚Äù.
          </p>
        </div>
      </div>

      <div class="metaPills">
        <div class="pill"><span class="dot" id="dotState"></span><span id="stateLabel">Prompt incomplet</span></div>
      </div>
    </div>

    <div class="grid">
      <!-- MAIN -->
      <div>
        <div class="card">
          <div class="inner">

            <!-- Contexte -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">‚ë†</div>
                  <div>
                    <p class="heroTitle">Contexte</p>
                    <p class="heroDesc"><strong>Attendu :</strong> URL + type de page + √©tats √† couvrir (initial / apr√®s clic / overlay / lazy-load).</p>
                  </div>
                </div>
                <div class="tags"><span class="tag req">Obligatoire</span></div>
              </div>
              <div class="label"><span>Contexte</span><span class="counter" id="c_context"></span></div>
              <textarea id="context" placeholder="Ex : URL: https://‚Ä¶ / listing. Tuiles pr√©sentes au chargement + ajout√©es apr√®s clic ‚Äúvoir tout‚Äù. Overlay d√©tail s‚Äôouvre/ferme."></textarea>
              <div class="hint"><strong>Astuce :</strong> mentionne ‚Äúdynamique / overlay / voir tout‚Äù si c‚Äôest le cas.</div>
            </div>

            <!-- O√π -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">‚ë°</div>
                  <div>
                    <p class="heroTitle">O√π ?</p>
                    <p class="heroDesc"><strong>Attendu :</strong> cibler <u>l‚Äô√©l√©ment</u> et/ou la <u>position exacte</u> de la modification (dans la tuile, au-dessus du prix, sous l‚Äôimage‚Ä¶).</p>
                  </div>
                </div>
                <div class="tags"><span class="tag req">Obligatoire</span></div>
              </div>
              <div class="label"><span>O√π (cible + position)</span><span class="counter" id="c_where"></span></div>
              <textarea id="where" placeholder="Ex : Cible : tuiles ‚ÄúiPhone 17‚Äù, ‚ÄúiPhone 17 Pro‚Äù, ‚ÄúiPhone 17 Pro Max‚Äù. Position : sous l‚Äôimage du t√©l√©phone, centr√©."></textarea>
            </div>

            <!-- Quoi -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">‚ë¢</div>
                  <div>
                    <p class="heroTitle">Quoi ?</p>
                    <p class="heroDesc"><strong>Attendu :</strong> s√©parer <u>l‚Äôaction</u> (Add/Replace/Transform/Calculate) du <u>contenu</u> (texte exact, format, formule).</p>
                  </div>
                </div>
                <div class="tags"><span class="tag req">Obligatoire</span></div>
              </div>

              <div class="row2">
                <div>
                  <div class="label"><span>Action</span><span class="counter" id="c_action"></span></div>
                  <textarea id="action" placeholder="Ex : Ajouter un message / Remplacer la ligne au-dessus du prix / Calculer et afficher le prix total."></textarea>
                </div>
                <div>
                  <div class="label"><span>Contenu (texte exact / format / formule)</span><span class="counter" id="c_content"></span></div>
                  <textarea id="content" placeholder="Ex : ‚Äú√Ä partir d‚Äô1‚Ç¨ ‚Ä¶‚Äù OU format ‚Äú9,99‚Ç¨/mois‚Äù o√π 9,99 = prix + |remise|."></textarea>
                </div>
              </div>

              <div class="hint">
                <strong>Si calcul :</strong> valeurs √† extraire + formule + format final. <strong>Si remplacement :</strong> ‚Äúuniquement X, ne pas toucher √† Y‚Äù.
              </div>
            </div>

            <!-- Limites -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">‚ë£</div>
                  <div>
                    <p class="heroTitle">Limites</p>
                    <p class="heroDesc"><strong>Attendu :</strong> ce qui ne doit pas bouger (charte, fond greige, typographies, layout) + r√®gles de style.</p>
                  </div>
                </div>
                <div class="tags"><span class="tag">Recommand√©</span></div>
              </div>
              <div class="label"><span>Limites / contraintes</span><span class="counter" id="c_limits"></span></div>
              <textarea id="limits" placeholder="Ex : Respecter fond greige + typographie. Ne pas modifier la grille/layout. Le message doit rester lisible sans d√©naturer."></textarea>
            </div>

            <!-- Approche -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">‚ë§</div>
                  <div>
                    <p class="heroTitle">Approche</p>
                    <p class="heroDesc"><strong>Attendu :</strong> robustesse (dynamique/overlay), r√©-application, idempotence (pas de doublons), fallback sans erreur.</p>
                  </div>
                </div>
                <div class="tags"><span class="tag">Recommand√©</span></div>
              </div>
              <div class="label"><span>Approche technique</span><span class="counter" id="c_approach"></span></div>
              <textarea id="approach" placeholder="Ex : Appliquer au chargement + r√©appliquer sur ajouts DOM (MutationObserver). Idempotent (data-processed). Fonctionner dans l‚Äôoverlay. Fallback : ne rien faire si cible introuvable."></textarea>
            </div>

            <!-- V√©rification -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">‚ë•</div>
                  <div>
                    <p class="heroTitle">V√©rification attendue</p>
                    <p class="heroDesc"><strong>Attendu :</strong> crit√®res visibles (persistance apr√®s interactions, overlay, style barr√©/gris, etc.).</p>
                  </div>
                </div>
                <div class="tags"><span class="tag">Optionnel</span></div>
              </div>
              <div class="label"><span>V√©rification</span><span class="counter" id="c_verify"></span></div>
              <textarea id="verify" placeholder="Ex : Le texte reste pr√©sent apr√®s interactions. Dans l‚Äôoverlay, il est visible. Si prix calcul√© : barr√© + gris partout."></textarea>
            </div>

          </div>
        </div>
      </div>

      <!-- SIDEBAR -->
      <div class="side">
        <div class="card">
          <div class="inner">
            <div class="qTop">
              <h3>Contr√¥le qualit√©</h3>
              <div class="scorePill" id="scorePill">0% ‚õî</div>
            </div>
            <div class="bar"><div id="scoreBar"></div></div>

            <div class="explain">
              <strong>Comment je d√©termine la qualit√©</strong><br>
              ‚Ä¢ <strong>Obligatoire :</strong> Contexte + O√π + Action + Contenu (sinon ‚ÄúPBX ne peut pas ex√©cuter‚Äù).<br>
              ‚Ä¢ <strong>Recommand√© :</strong> Limites (√©viter de casser le design).<br>
              ‚Ä¢ <strong>Recommand√© fort :</strong> Approche si la page est <em>dynamique</em> (overlay / ‚Äúvoir tout‚Äù).<br>
              ‚Ä¢ Dans la liste ci-dessous, tu vois exactement <strong>ce qui manque</strong> + un <strong>exemple</strong> √† copier.
            </div>

            <div class="checks" id="checks"></div>

            <!-- ‚úÖ GARDER CES 3 BOUTONS UNIQUEMENT -->
            <div class="actions">
              <button class="btn primary" id="btnGenerate" type="button">‚öôÔ∏è G√©n√©rer le prompt</button>
              <button class="btn ghost" id="btnCopy" type="button" disabled>üìã Copier</button>
              <button class="btn danger" id="btnReset" type="button">üóëÔ∏è R√©initialiser</button>
            </div>

            <div class="divider"></div>

            <!-- Prompt pr√™t √† coller en derni√®re position de la sidebar -->
            <div class="resultHead">
              <h3>Prompt PBX pr√™t √† coller</h3>
              <span class="badge" id="genBadge">Incomplet</span>
            </div>
            <textarea id="result" readonly placeholder="Clique ‚ÄúG√©n√©rer le prompt‚Äù."></textarea>
            <div class="toast" id="toast">Copi√© ‚úÖ</div>

          </div>
        </div>
      </div>

    </div>
  </div>

<script>
  // SAFE helpers
  const $ = (id) => document.getElementById(id);
  const on = (el, evt, fn) => { if (el) el.addEventListener(evt, fn); };

  document.addEventListener("DOMContentLoaded", () => {
    console.log("[DEBUG] DOMContentLoaded fired");

    const SKEY = "pbx_prompt_form_debug_v1";

    // Grab elements (can be null if markup differs)
    const els = {
      context: $("context"),
      where: $("where"),
      action: $("action"),
      content: $("content"),
      limits: $("limits"),
      approach: $("approach"),
      verify: $("verify"),

      result: $("result"),
      toast: $("toast"),

      btnGenerate: $("btnGenerate"),
      btnCopy: $("btnCopy"),
      btnReset: $("btnReset"),

      scorePill: $("scorePill"),
      scoreBar: $("scoreBar"),
      checks: $("checks"),

      dotState: $("dotState"),
      stateLabel: $("stateLabel"),
      genBadge: $("genBadge"),

      c_context: $("c_context"),
      c_where: $("c_where"),
      c_action: $("c_action"),
      c_content: $("c_content"),
      c_limits: $("c_limits"),
      c_approach: $("c_approach"),
      c_verify: $("c_verify"),
    };

    // DEBUG: dump element presence
    console.log("[DEBUG] Element presence:", {
      context: !!els.context,
      where: !!els.where,
      action: !!els.action,
      content: !!els.content,
      limits: !!els.limits,
      approach: !!els.approach,
      verify: !!els.verify,
      result: !!els.result,
      toast: !!els.toast,
      btnGenerate: !!els.btnGenerate,
      btnCopy: !!els.btnCopy,
      btnReset: !!els.btnReset,
      scorePill: !!els.scorePill,
      scoreBar: !!els.scoreBar,
      checks: !!els.checks,
      dotState: !!els.dotState,
      stateLabel: !!els.stateLabel,
      genBadge: !!els.genBadge
    });

    // DEBUG: print actual button nodes (helps if duplicated IDs / shadow DOM etc.)
    console.log("[DEBUG] Buttons nodes:", {
      btnGenerate: els.btnGenerate,
      btnCopy: els.btnCopy,
      btnReset: els.btnReset
    });

    // If core buttons missing, show error + stop
    if (!els.btnGenerate || !els.btnCopy || !els.btnReset) {
      console.error("[DEBUG] Missing CTA buttons. Check IDs: btnGenerate, btnCopy, btnReset");
      if (els.result) {
        els.result.value =
          "‚ùå [DEBUG] Erreur markup : bouton introuvable.\n" +
          "IDs attendus : btnGenerate / btnCopy / btnReset.\n" +
          "Ouvre la console pour voir quels √©l√©ments sont pr√©sents.";
      }
      return;
    }

    const vagueMarkers = [
      "am√©liorer","optimiser","faire mieux","rendre plus","peaufiner","comme tu veux","√† ta guise","peu importe",
      "make it better","optimize","improve"
    ];
    const actionVerbsFR = ["ajouter","remplacer","modifier","d√©placer","supprimer","r√©√©crire","ins√©rer","mettre √† jour","transformer","calculer","afficher"];
    const actionVerbsEN = ["add","replace","change","move","remove","rewrite","insert","update","transform","calculate","display"];

    const countChars = (v) => (v || "").trim().length;
    const setCounter = (el, v) => {
      if(!el) return;
      el.textContent = countChars(v) ? `${countChars(v)} car.` : "";
    };

    function looksVagueSection(text, kind){
      const t = (text || "").trim();
      if(!t) return true;
      const low = t.toLowerCase();
      const hasVague = vagueMarkers.some(m => low.includes(m));

      if(kind === "context"){
        const hasUrl = /(https?:\/\/|www\.)/i.test(t);
        const hasState = /(chargement|initial|overlay|modal|voir tout|voir le d√©tail|pagination|filtre|lazy|dynamique|scroll|ajax)/i.test(t);
        if(t.length < 30) return true;
        if(!hasUrl && !hasState) return true;
        if(hasVague && !hasUrl && !hasState) return true;
        return false;
      }
      if(kind === "where"){
        const hasTargetHint = /(tuile|carte|bloc|section|bouton|cta|prix|image|h1|titre|ligne|au-dessus|en dessous|sous|centr√©|droite|gauche|overlay|modal|listing)/i.test(t);
        const hasSpecific = /["‚Äú‚Äù']|\b(iPhone|forfait|‚Ç¨/mois|prix)\b/i.test(t);
        if(t.length < 20) return true;
        if(!hasTargetHint && !hasSpecific) return true;
        if(hasVague && !hasTargetHint) return true;
        return false;
      }
      if(kind === "action"){
        const hasVerb = [...actionVerbsFR, ...actionVerbsEN].some(v => low.includes(v));
        if(t.length < 10) return true;
        if(!hasVerb) return true;
        if(hasVague) return true;
        return false;
      }
      if(kind === "content"){
        const hasConcrete = /["‚Äú‚Äù']|\b\d+([,.]\d+)?\b|‚Ç¨|\/mois|format|formule|calcul/i.test(t);
        if(t.length < 12) return true;
        if(hasVague && !hasConcrete) return true;
        if(!hasConcrete) return true;
        return false;
      }
      if(kind === "limits"){ return t.length < 18; }
      if(kind === "approach"){ return t.length < 18; }
      return false;
    }

    function needsApproachFromContext(){
      const t = `${els.context?.value || ""} ${els.where?.value || ""}`.toLowerCase();
      const res = /(overlay|modal|voir tout|voir le d√©tail|pagination|filtre|lazy|dynamique|ajax|infinite|scroll)/i.test(t);
      console.log("[DEBUG] needsApproachFromContext?", res, "input=", t);
      return res;
    }

    function computeQuality(){
      const missing = [];
      const warnings = [];

      const ctx = (els.context?.value || "").trim();
      const whr = (els.where?.value || "").trim();
      const act = (els.action?.value || "").trim();
      const cnt = (els.content?.value || "").trim();
      const lim = (els.limits?.value || "").trim();
      const app = (els.approach?.value || "").trim();

      console.log("[DEBUG] computeQuality values:", {ctx, whr, act, cnt, lim, app});

      if(!ctx || looksVagueSection(ctx,"context")){
        missing.push({ key:"Contexte", d:"Ajoute l‚ÄôURL + au moins 1 √©tat (initial / apr√®s clic / overlay / dynamique).",
          example:"URL: https://‚Ä¶ / listing. Appliquer au chargement + apr√®s clic ‚Äúvoir tout‚Äù + overlay d√©tail." });
      }
      if(!whr || looksVagueSection(whr,"where")){
        missing.push({ key:"O√π", d:"Indique l‚Äô√©l√©ment cibl√© ET/OU la position exacte de la modification.",
          example:"Dans les tuiles iPhone 17/17 Pro/17 Pro Max, sous l‚Äôimage, centr√©." });
      }
      if(!act || looksVagueSection(act,"action")){
        missing.push({ key:"Action", d:"Utilise un verbe clair (ajouter / remplacer / calculer / d√©placer‚Ä¶).",
          example:"Remplacer la ligne au-dessus du prix." });
      }
      if(!cnt || looksVagueSection(cnt,"content")){
        missing.push({ key:"Contenu", d:"Donne le texte exact OU un format + formule (si calcul).",
          example:"‚Äú√Ä partir d‚Äô1‚Ç¨ ‚Ä¶‚Äù OU ‚ÄúAfficher 9,99‚Ç¨/mois = prix + |remise|‚Äù." });
      }

      if(!lim){
        warnings.push({ key:"Limites", d:"Ajoute les garde-fous (charte/fond/typo/layout).",
          example:"Ne pas modifier le layout. Respecter fond greige + typographie." });
      }

      const needApp = needsApproachFromContext();
      if(needApp && !app){
        warnings.push({ key:"Approche", d:"Comme c‚Äôest dynamique (overlay/ajouts), pr√©cise r√©-application + idempotence.",
          example:"MutationObserver + apply() idempotent (data-processed) + overlays." });
      }

      let score = 100;
      score -= missing.length * 28;
      score -= warnings.length * 12;
      score = Math.max(0, Math.min(100, score));

      const ready = (missing.length === 0 && score >= 70);
      const state = ready ? "ready" : (score >= 50 ? "warn" : "bad");

      console.log("[DEBUG] computeQuality result:", {score, ready, state, missingCount: missing.length, warningsCount: warnings.length});
      return {score, ready, state, missing, warnings, needApp};
    }

    function buildPBXPrompt(q){
      console.log("[DEBUG] buildPBXPrompt called. ready=", q.ready);
      const blocks = [];
      blocks.push("Front-end variation only (no back-end changes).");
      blocks.push("\nContexte :\n" + (els.context?.value || "").trim());
      blocks.push("\nO√π :\n" + (els.where?.value || "").trim());
      blocks.push("\nAction :\n" + (els.action?.value || "").trim());
      blocks.push("\nContenu :\n" + (els.content?.value || "").trim());
      if((els.limits?.value || "").trim()) blocks.push("\nLimites :\n" + els.limits.value.trim());
      if((els.approach?.value || "").trim()){
        blocks.push("\nApproche :\n" + els.approach.value.trim());
      } else if(q.needApp){
        blocks.push("\nApproche :\nAppliquer au chargement + r√©appliquer lors d‚Äôajouts DOM (MutationObserver). Idempotent (pas de doublons). Fonctionner dans overlays si pr√©sents. Fallback : ne rien faire si cible introuvable.");
      }
      if((els.verify?.value || "").trim()) blocks.push("\nV√©rification :\n" + els.verify.value.trim());
      blocks.push("\nAttendu :\nG√©n√©rer le code robuste qui applique strictement ces r√®gles sans d√©grader le design et sans erreur console.");
      return blocks.join("\n").trim();
    }

    function buildMissingPreview(q){
      console.log("[DEBUG] buildMissingPreview called");
      const lines = [];
      lines.push("Ce qui manque pour un prompt PBX exploitable :\n");
      q.missing.forEach(m => { lines.push(`- [OBLIGATOIRE] ${m.key} : ${m.d}\n  Ex : ${m.example}\n`); });
      q.warnings.forEach(w => { lines.push(`- [RECOMMAND√â] ${w.key} : ${w.d}\n  Ex : ${w.example}\n`); });
      return lines.join("\n").trim();
    }

    function toast(msg){
      console.log("[DEBUG] toast:", msg);
      if(!els.toast) return;
      els.toast.textContent = msg;
      els.toast.style.display = "block";
      setTimeout(()=> els.toast.style.display="none", 1600);
    }

    function renderChecks(q){
      console.log("[DEBUG] renderChecks called");
      if(!els.checks) return;
      const items = [];
      const row = (state, title, desc, example) => {
        const icon = state === "ok" ? "‚úì" : (state === "warn" ? "!" : "√ó");
        const ex = example ? `<br><span style="color: var(--muted2);">Ex : ${example}</span>` : "";
        items.push(`
          <div class="item ${state}">
            <div class="ico">${icon}</div>
            <div>
              <p class="itT">${title}</p>
              <p class="itD">${desc}${ex}</p>
            </div>
          </div>
        `);
      };

      const ctx = (els.context?.value || "").trim();
      const whr = (els.where?.value || "").trim();
      const act = (els.action?.value || "").trim();
      const cnt = (els.content?.value || "").trim();

      row(!ctx || looksVagueSection(ctx,"context") ? "bad" : "ok", "Contexte",
          !ctx || looksVagueSection(ctx,"context") ? "Manque URL + √©tat(s) (initial / apr√®s clic / overlay)." : "OK ‚Äî exploitable.",
          "URL: https://‚Ä¶ + overlay/voir tout si pr√©sent.");

      row(!whr || looksVagueSection(whr,"where") ? "bad" : "ok", "O√π (cible/position)",
          !whr || looksVagueSection(whr,"where") ? "Manque √©l√©ment cibl√© + position exacte." : "OK ‚Äî clair.",
          "Dans la tuile X, sous l‚Äôimage, centr√©.");

      row(!act || looksVagueSection(act,"action") ? "bad" : "ok", "Action",
          !act || looksVagueSection(act,"action") ? "Manque un verbe clair." : "OK ‚Äî action claire.",
          "Ajouter / Remplacer / Calculer / D√©placer‚Ä¶");

      row(!cnt || looksVagueSection(cnt,"content") ? "bad" : "ok", "Contenu / format",
          !cnt || looksVagueSection(cnt,"content") ? "Manque texte exact OU format/formule." : "OK ‚Äî concret.",
          "‚Äú√Ä partir d‚Äô1‚Ç¨ ‚Ä¶‚Äù OU ‚Äú9,99‚Ç¨/mois = prix + |remise|‚Äù");

      if(q.missing.length || q.warnings.length){
        items.push(`<div style="margin-top:6px;"></div>`);
        [...q.missing, ...q.warnings].slice(0, 8).forEach(m => {
          const isBad = q.missing.includes(m);
          row(isBad ? "bad" : "warn", `${m.key} ‚Äî √† compl√©ter`, m.d, m.example);
        });
      }

      els.checks.innerHTML = items.join("");
    }

    function updateUI(){
      console.log("[DEBUG] updateUI called");
      setCounter(els.c_context, els.context?.value);
      setCounter(els.c_where, els.where?.value);
      setCounter(els.c_action, els.action?.value);
      setCounter(els.c_content, els.content?.value);
      setCounter(els.c_limits, els.limits?.value);
      setCounter(els.c_approach, els.approach?.value);
      setCounter(els.c_verify, els.verify?.value);

      const q = computeQuality();

      if (els.scorePill) els.scorePill.textContent = `${q.score}% ${q.ready ? "‚úÖ" : "‚õî"}`;
      if (els.scoreBar) els.scoreBar.style.width = `${q.score}%`;

      if (els.dotState) els.dotState.style.background = q.state === "ready" ? "var(--good)" : (q.state === "warn" ? "var(--warn)" : "var(--bad)");
      if (els.stateLabel) els.stateLabel.textContent = q.state === "ready" ? "Prompt pr√™t" : (q.state === "warn" ? "Presque pr√™t" : "Prompt incomplet");
      if (els.genBadge) els.genBadge.textContent = q.ready ? "PBX-ready" : "Incomplet";

      renderChecks(q);

      // Save
      try{
        localStorage.setItem(SKEY, JSON.stringify({
          context: els.context?.value || "",
          where: els.where?.value || "",
          action: els.action?.value || "",
          content: els.content?.value || "",
          limits: els.limits?.value || "",
          approach: els.approach?.value || "",
          verify: els.verify?.value || ""
        }));
        console.log("[DEBUG] saved to localStorage", SKEY);
      }catch(e){
        console.warn("[DEBUG] localStorage save failed", e);
      }

      return q;
    }

    function load(){
      console.log("[DEBUG] load() called");
      try{
        const raw = localStorage.getItem(SKEY);
        console.log("[DEBUG] localStorage get", SKEY, raw ? "(found)" : "(empty)");
        if(!raw) return;
        const p = JSON.parse(raw);
        if(els.context && p.context != null) els.context.value = p.context;
        if(els.where && p.where != null) els.where.value = p.where;
        if(els.action && p.action != null) els.action.value = p.action;
        if(els.content && p.content != null) els.content.value = p.content;
        if(els.limits && p.limits != null) els.limits.value = p.limits;
        if(els.approach && p.approach != null) els.approach.value = p.approach;
        if(els.verify && p.verify != null) els.verify.value = p.verify;
      }catch(e){
        console.warn("[DEBUG] load failed", e);
      }
    }

    function generate(){
      console.log("[DEBUG] CLICK generate");
      const q = updateUI();
      if(!els.result){
        console.error("[DEBUG] result textarea not found (#result)");
        return;
      }
      if(q.ready){
        els.result.value = buildPBXPrompt(q);
        toast("Prompt g√©n√©r√© ‚úÖ");
      } else {
        els.result.value = buildMissingPreview(q);
        toast("√Ä compl√©ter ‚ö†Ô∏è");
      }
      els.btnCopy.disabled = !els.result.value.trim();
      console.log("[DEBUG] generate done. copyDisabled=", els.btnCopy.disabled);
    }

    async function copy(){
      console.log("[DEBUG] CLICK copy");
      const v = (els.result?.value || "").trim();
      if(!v){
        console.warn("[DEBUG] copy: nothing to copy");
        return;
      }
      try{
        await navigator.clipboard.writeText(v);
        toast("Copi√© ‚úÖ");
      }catch(e){
        console.warn("[DEBUG] clipboard failed, fallback", e);
        els.result?.select?.();
        document.execCommand("copy");
        toast("Copi√© ‚úÖ");
      }
    }

    function resetAll(){
      console.log("[DEBUG] CLICK reset");
      const ok = confirm("R√©initialiser ?");
      console.log("[DEBUG] reset confirm =", ok);
      if(!ok) return;

      ["context","where","action","content","limits","approach","verify"].forEach(k => {
        if(els[k]) els[k].value = "";
      });
      if(els.result) els.result.value = "";
      els.btnCopy.disabled = true;

      try{
        localStorage.removeItem(SKEY);
        console.log("[DEBUG] localStorage removed", SKEY);
      }catch(e){
        console.warn("[DEBUG] localStorage remove failed", e);
      }

      updateUI();
      toast("R√©initialis√© ‚úÖ");
    }

    // Bind inputs safely
    ["context","where","action","content","limits","approach","verify"].forEach(id=>{
      const el = $(id);
      if(!el) console.warn("[DEBUG] missing input element #"+id);
      on(el, "input", updateUI);
      on(el, "change", updateUI);
    });

    // Bind the 3 CTAs
    console.log("[DEBUG] binding CTA events...");
    on(els.btnGenerate, "click", generate);
    on(els.btnCopy, "click", copy);
    on(els.btnReset, "click", resetAll);
    console.log("[DEBUG] CTA events bound");

    // Init
    load();
    updateUI();

    // Extra: global click probe to see if clicks are swallowed by overlay
    document.addEventListener("click", (e) => {
      const t = e.target;
      if(!(t instanceof Element)) return;
      const id = t.id || "(no id)";
      const cls = t.className || "(no class)";
      if (id === "btnGenerate" || id === "btnCopy" || id === "btnReset") {
        console.log("[DEBUG] document click saw CTA target:", { id, cls, tag: t.tagName });
      }
    }, true);

    // Extra: detect runtime errors that kill interactivity
    window.addEventListener("error", (e) => {
      console.error("[DEBUG] window.error", e.message, e.filename, e.lineno, e.colno, e.error);
    });
    window.addEventListener("unhandledrejection", (e) => {
      console.error("[DEBUG] unhandledrejection", e.reason);
    });
  });
</script>
</body>
</html>
