<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PBX Prompt Builder ‚Äî Brief Qualit√© (anti-cr√©dits grill√©s)</title>
  <style>
    :root{
      --bg:#F6F7FB;
      --card:#FFFFFF;
      --ink:#0F172A;
      --muted:#64748B;
      --muted2:#94A3B8;
      --line:#E2E8F0;

      --primary:#6D28D9;
      --teal:#14B8A6;

      --good:#22C55E;
      --warn:#F59E0B;
      --bad:#EF4444;

      --shadow: 0 14px 40px rgba(15, 23, 42, 0.10);
      --shadow2: 0 10px 26px rgba(15, 23, 42, 0.07);

      --r:18px;
      --r2:14px;
    }

    *{ box-sizing:border-box; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", sans-serif; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 520px at 15% -10%, rgba(109,40,217,0.16), transparent 55%),
        radial-gradient(1200px 520px at 85% -10%, rgba(20,184,166,0.14), transparent 55%),
        var(--bg);
      color:var(--ink);
      min-height:100vh;
      padding: 20px 14px 46px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }

    .wrap{ width:100%; max-width: 1200px; }

    /* Header */
    .top{
      display:flex;
      gap:14px;
      justify-content:space-between;
      align-items:flex-start;
      flex-wrap:wrap;
      margin-bottom: 14px;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:flex-start;
      min-width: 280px;
      flex: 1 1 680px;
    }
    .logo{
      width:44px; height:44px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--primary), var(--teal));
      box-shadow: var(--shadow2);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:900;
      letter-spacing:-0.3px;
      flex-shrink:0;
    }
    h1{
      margin:0;
      font-size: 22px;
      letter-spacing:-0.2px;
      line-height:1.2;
    }
    .sub{
      margin:5px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height:1.35;
      max-width: 840px;
    }

    .metaPills{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      flex: 1 1 360px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,0.88);
      box-shadow: 0 10px 22px rgba(15,23,42,0.05);
      font-size: 12.5px;
      color: var(--muted);
      white-space:nowrap;
    }
    .dot{
      width:9px; height:9px; border-radius:999px;
      background: var(--muted2);
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11.5px;
      padding: 2px 6px;
      border-radius: 8px;
      background: rgba(2,6,23,0.06);
      border: 1px solid rgba(15,23,42,0.10);
      color: #0f172a;
      white-space: nowrap;
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1fr 380px;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 1020px){
      .grid{ grid-template-columns: 1fr; }
      .side{ position: static !important; }
    }

    .card{
      background: rgba(255,255,255,0.92);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow2);
    }
    .card .inner{ padding: 16px; }

    /* Step cards */
    .steps{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 14px;
    }
    @media (max-width: 820px){ .steps{ grid-template-columns: 1fr 1fr; } }
    .step{
      border: 1px solid var(--line);
      border-radius: 16px;
      background: rgba(255,255,255,0.82);
      padding: 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .step .n{
      width:26px; height:26px;
      border-radius:999px;
      background: rgba(109,40,217,0.12);
      color: var(--primary);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      flex-shrink:0;
    }
    .step .t{ margin:0; font-size: 12.6px; font-weight: 900; letter-spacing:-0.1px; }
    .step .d{ margin:3px 0 0; font-size: 12px; color: var(--muted); line-height:1.35; }

    /* Sections */
    .section{
      border: 1px solid var(--line);
      border-radius: 18px;
      background: rgba(255,255,255,0.78);
      padding: 14px;
      margin-bottom: 12px;
    }
    .shead{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .sleft{ display:flex; gap:10px; align-items:flex-start; }
    .sicon{
      width:34px; height:34px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(109,40,217,0.12), rgba(20,184,166,0.12));
      border: 1px solid rgba(109,40,217,0.18);
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--primary);
      font-weight: 950;
      flex-shrink:0;
    }
    .stitle{ margin:0; font-size: 14px; font-weight: 950; letter-spacing:-0.15px; }
    .sdesc{ margin:3px 0 0; font-size: 12.5px; color: var(--muted); line-height:1.35; }
    .stags{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .tag{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--muted);
      white-space:nowrap;
    }
    .tag.req{
      border-color: rgba(239,68,68,0.22);
      background: rgba(239,68,68,0.06);
      color: #991B1B;
      font-weight: 900;
    }

    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    @media (max-width: 860px){ .row2, .row3{ grid-template-columns: 1fr; } }

    .field{ margin-top: 10px; }
    .label{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 6px;
      align-items:center;
      flex-wrap:wrap;
    }
    .label span{
      font-size: 12.7px;
      font-weight: 900;
      letter-spacing:-0.1px;
    }
    .help{
      font-size: 11.7px;
      color: var(--muted2);
    }
    .counter{
      font-size: 11.7px;
      color: var(--muted2);
      white-space:nowrap;
    }

    textarea, input[type="text"], select{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(248,250,252,0.85);
      padding: 10px 11px;
      font-size: 13.6px;
      outline:none;
      transition: border-color .15s, box-shadow .15s, background .15s;
      line-height: 1.35;
    }
    textarea{ min-height: 88px; resize: vertical; }
    textarea:focus, input:focus, select:focus{
      border-color: rgba(109,40,217,0.55);
      box-shadow: 0 0 0 3px rgba(109,40,217,0.18);
      background: #fff;
    }

    .hint{
      margin-top: 6px;
      padding: 10px 11px;
      border-radius: 14px;
      border: 1px dashed rgba(100,116,139,0.24);
      background: rgba(2,6,23,0.03);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .hint strong{ color: var(--ink); }

    /* Sidebar */
    .side{ position: sticky; top: 14px; }

    .qTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom: 10px;
    }
    .qTop h3{
      margin:0;
      font-size: 14px;
      font-weight: 950;
      letter-spacing:-0.15px;
    }
    .scorePill{
      font-size: 12.5px;
      font-weight: 950;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--muted);
      white-space:nowrap;
    }
    .bar{
      height: 10px;
      background: #E2E8F0;
      border-radius: 999px;
      overflow:hidden;
      margin-bottom: 10px;
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: var(--good);
      transition: width .2s ease, background .2s ease;
    }

    .checks{
      display:grid;
      gap:10px;
      margin-top: 10px;
    }
    .item{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.86);
    }
    .ico{
      width:26px; height:26px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight: 950;
      flex-shrink:0;
      background: var(--muted2);
    }
    .item.ok .ico{ background: var(--good); }
    .item.warn .ico{ background: var(--warn); }
    .item.bad .ico{ background: var(--bad); }

    .itT{ margin:0; font-size: 12.6px; font-weight: 950; letter-spacing:-0.1px; }
    .itD{ margin: 2px 0 0; font-size: 12px; color: var(--muted); line-height:1.35; }

    .actions{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 12px;
    }
    .btn{
      border: none;
      border-radius: 16px;
      padding: 11px 12px;
      font-size: 13.7px;
      font-weight: 950;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition: transform .06s ease, opacity .15s ease, box-shadow .15s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, var(--primary), var(--teal));
      color:#fff;
      box-shadow: 0 14px 30px rgba(109,40,217,0.20);
    }
    .btn.ghost{
      background: #fff;
      border: 1px solid var(--line);
      color: var(--ink);
    }
    .btn.danger{
      background: rgba(239,68,68,0.08);
      border: 1px solid rgba(239,68,68,0.22);
      color: #991B1B;
    }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; box-shadow:none; }

    .mini{
      margin-top: 10px;
      font-size: 12px;
      line-height:1.35;
      color: var(--muted);
    }

    /* Result */
    .resultHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 8px;
    }
    .resultHead h3{
      margin:0;
      font-size: 14px;
      font-weight: 950;
      letter-spacing:-0.15px;
    }
    .badge{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--muted);
      white-space:nowrap;
    }
    #result{
      width:100%;
      min-height: 240px;
      border-radius: 16px;
      border: none;
      outline:none;
      padding: 12px 12px;
      background: #020617;
      color: #E5E7EB;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12.8px;
      line-height: 1.45;
      white-space: pre-wrap;
    }
    .toast{
      display:none;
      margin-top: 8px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(34,197,94,0.25);
      background: rgba(34,197,94,0.08);
      color: #14532D;
      font-weight: 950;
      font-size: 12.5px;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">PBX</div>
        <div>
          <h1>Prompt Builder ‚Äî Variation PBX (anti-cr√©dits grill√©s)</h1>
          <p class="sub">
            PBX sert √† <strong>g√©n√©rer une variation</strong> sur une page existante. Ce formulaire bloque la g√©n√©ration tant qu‚Äôil manque des infos
            critiques (<strong>where / target / what / constraints / output</strong>). Pas de backend.
          </p>
        </div>
      </div>

      <div class="metaPills">
        <div class="pill"><span class="dot" id="dotState"></span><span id="stateLabel">Brief incomplet</span></div>
        <div class="pill">Raccourcis : <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span></div>
      </div>
    </div>

    <div class="grid">
      <!-- MAIN -->
      <div>
        <div class="card">
          <div class="inner">

            <div class="steps">
              <div class="step"><div class="n">1</div><div><p class="t">Where</p><p class="d">Page + scope + cible stable.</p></div></div>
              <div class="step"><div class="n">2</div><div><p class="t">What</p><p class="d">Changement concret (1 variation).</p></div></div>
              <div class="step"><div class="n">3</div><div><p class="t">How</p><p class="d">Contraintes + responsive + interdits.</p></div></div>
              <div class="step"><div class="n">4</div><div><p class="t">Output</p><p class="d">R√©sultat QA-friendly, v√©rifiable.</p></div></div>
            </div>

            <!-- 0) Intent -->
            <div class="section">
              <div class="shead">
                <div class="sleft">
                  <div class="sicon">‚óé</div>
                  <div>
                    <p class="stitle">0) Un prompt = une variation (use case unique)</p>
                    <p class="sdesc">Si tu m√©langes plusieurs objectifs, PBX produit des changements incoh√©rents.</p>
                  </div>
                </div>
                <div class="stags">
                  <span class="tag req">Obligatoire</span>
                </div>
              </div>

              <div class="row2">
                <div class="field">
                  <div class="label">
                    <span>Objectif / KPI principal (recommand√©)</span>
                    <span class="counter" id="c_goal"></span>
                  </div>
                  <textarea id="goal" placeholder="Ex : augmenter le clic vers /pricing (CTR du CTA) / r√©duire l'abandon panier / augmenter soumissions formulaire."></textarea>
                  <div class="hint"><strong>Pourquoi :</strong> √ßa guide la variation (angle, promesse, clart√©, confiance).</div>
                </div>

                <div class="field">
                  <div class="label">
                    <span>Use case (1 phrase)</span>
                    <span class="counter" id="c_usecase"></span>
                  </div>
                  <input id="useCase" type="text" placeholder="Ex : Modifier le libell√© du CTA du bloc pricing pour augmenter le clic." />
                  <div class="hint"><strong>Anti-erreur :</strong> √©vite ‚Äúoptimiser la page‚Äù, ‚Äúam√©liorer l‚ÄôUX‚Äù.</div>
                </div>
              </div>
            </div>

            <!-- 1) Where -->
            <div class="section">
              <div class="shead">
                <div class="sleft">
                  <div class="sicon">‚ûä</div>
                  <div>
                    <p class="stitle">1) Where ‚Äî page + cible (stable) + scope</p>
                    <p class="sdesc">PBX doit savoir pr√©cis√©ment o√π agir. Id√©alement : identifiant stable (aria-label, data-testid, texte exact).</p>
                  </div>
                </div>
                <div class="stags">
                  <span class="tag req">Obligatoire</span>
                  <span class="tag">Stable ID (reco)</span>
                </div>
              </div>

              <div class="row2">
                <div class="field">
                  <div class="label">
                    <span>URL / route</span>
                    <span class="counter" id="c_page"></span>
                  </div>
                  <input id="page" type="text" placeholder="Ex : https://site.com/ ou /pricing ou /checkout/step-2" />
                  <div class="hint">Si tu n‚Äôas pas l‚ÄôURL, indique page + emplacement (‚ÄúHome > section pricing teaser‚Äù).</div>
                </div>

                <div class="field">
                  <div class="label">
                    <span>√âl√©ment cibl√© (1 principal)</span>
                    <span class="counter" id="c_target"></span>
                  </div>
                  <textarea id="target" placeholder="Ex : Bouton CTA du bloc pricing (texte du bouton uniquement) / H1 hero / microcopy erreur email."></textarea>
                </div>
              </div>

              <div class="row2">
                <div class="field">
                  <div class="label">
                    <span>Identifiant stable (recommand√©)</span>
                    <span class="help">anti-variation fragile</span>
                  </div>
                  <textarea id="identifier" placeholder="Ex : data-testid='pricing-cta' / aria-label='See pricing' / texte exact : ‚ÄúVoir les offres‚Äù (ou CSS en dernier recours)."></textarea>
                  <div class="hint"><strong>Conseil :</strong> texte exact ou aria/data-testid > CSS fragile.</div>
                </div>

                <div class="field">
                  <div class="label">
                    <span>Scope autoris√© (ce qui peut changer)</span>
                    <span class="counter" id="c_scope"></span>
                  </div>
                  <textarea id="scope" placeholder="Ex : Ne modifier que le CTA et √©ventuellement le sous-texte du bloc. Ne pas toucher au layout global."></textarea>
                </div>
              </div>
            </div>

            <!-- 2) What -->
            <div class="section">
              <div class="shead">
                <div class="sleft">
                  <div class="sicon">‚ûã</div>
                  <div>
                    <p class="stitle">2) What ‚Äî changement concret √† g√©n√©rer</p>
                    <p class="sdesc">D√©cris une variation pr√©cise. Pas ‚Äúam√©liorer‚Äù sans d√©tail : PBX doit ex√©cuter.</p>
                  </div>
                </div>
                <div class="stags">
                  <span class="tag req">Obligatoire</span>
                  <span class="tag">1 variation</span>
                </div>
              </div>

              <div class="row3">
                <div class="field">
                  <div class="label">
                    <span>Type de variation</span>
                    <span class="help">d√©clenche contraintes</span>
                  </div>
                  <select id="variationType">
                    <option value="copy">Copy / microcopy (texte)</option>
                    <option value="layout">Layout / hi√©rarchie (front-end)</option>
                    <option value="visual">Visuel / style (front-end)</option>
                    <option value="component">Nouveau composant (front-end)</option>
                  </select>
                  <div class="hint"><strong>Le plus safe :</strong> copy-only (moins de risques responsive).</div>
                </div>

                <div class="field">
                  <div class="label">
                    <span>Changement exact (livrable)</span>
                    <span class="counter" id="c_action"></span>
                  </div>
                  <textarea id="action" placeholder="Ex : Remplacer le libell√© du CTA par une formulation b√©n√©fice, plus explicite, pour augmenter le clic."></textarea>
                </div>

                <div class="field">
                  <div class="label">
                    <span>Hypoth√®se (reco)</span>
                    <span class="help">why it works</span>
                  </div>
                  <textarea id="hypothesis" placeholder="Ex : CTA plus explicite => meilleure compr√©hension de l‚Äô√©tape suivante => + clic."></textarea>
                </div>
              </div>

              <div class="row2">
                <div class="field">
                  <div class="label">
                    <span>Audience / contexte</span>
                    <span class="counter" id="c_audience"></span>
                  </div>
                  <textarea id="audience" placeholder="Ex : prospects B2B, nouveaux visiteurs, mobile majoritaire, pas experts du produit."></textarea>
                </div>

                <div class="field">
                  <div class="label">
                    <span>Contenu utile (value prop, preuves, objections)</span>
                    <span class="counter" id="c_data"></span>
                  </div>
                  <textarea id="data" placeholder="Ex : preuve = 2 000 clients; avantage = setup 10 min; objection = prix; ton = premium simple."></textarea>
                </div>
              </div>
            </div>

            <!-- 3) How -->
            <div class="section">
              <div class="shead">
                <div class="sleft">
                  <div class="sicon">‚ûå</div>
                  <div>
                    <p class="stitle">3) How ‚Äî contraintes, interdits, responsive</p>
                    <p class="sdesc">Les garde-fous qui √©vitent les sorties inutilisables (et donc les cr√©dits consomm√©s).</p>
                  </div>
                </div>
                <div class="stags">
                  <span class="tag req">Obligatoire</span>
                  <span class="tag">No backend</span>
                </div>
              </div>

              <div class="row2">
                <div class="field">
                  <div class="label">
                    <span>Contraintes (hard rules)</span>
                    <span class="counter" id="c_constraints"></span>
                  </div>
                  <textarea id="constraints" placeholder="Ex : FR. 2‚Äì4 mots. Pas d‚Äôemoji. Pas de promesse (‚Äògaranti‚Äô). Ton rassurant."></textarea>
                </div>

                <div class="field">
                  <div class="label">
                    <span>√Ä √©viter (ban list)</span>
                    <span class="counter" id="c_avoid"></span>
                  </div>
                  <textarea id="avoid" placeholder="Ex : √©viter ‚ÄúAchetez‚Äù, ‚ÄúUrgent‚Äù, ‚ÄúPromo‚Äù, jargon, anglicismes, claims non prouvables."></textarea>
                </div>
              </div>

              <div class="row2">
                <div class="field">
                  <div class="label">
                    <span>Responsive / devices</span>
                    <span class="help" id="respHelp">obligatoire si layout/visuel/composant</span>
                  </div>
                  <textarea id="responsive" placeholder="Ex : doit fonctionner desktop + mobile; ne pas casser la grille; conserver spacing/tailles; mobile prioritaire."></textarea>
                  <div class="hint"><strong>Important :</strong> si tu touches au layout/visuel/composant, pr√©cise ce qui ne doit pas bouger.</div>
                </div>

                <div class="field">
                  <div class="label">
                    <span>Style / charte (reco)</span>
                    <span class="help">coh√©rence marque</span>
                  </div>
                  <textarea id="style" placeholder="Ex : style sobre, pas agressif, vocabulaire simple, tutoiement, coh√©rent marque."></textarea>
                </div>
              </div>

              <div class="field" style="margin-top:12px;">
                <div class="label">
                  <span>Contraintes techniques (optionnel, front-end uniquement)</span>
                  <span class="help">√©viter bruit back-end</span>
                </div>
                <textarea id="tech" placeholder="Ex : On peut changer uniquement le texte; pas de nouvelle API; pas de logique serveur; pas de refonte globale."></textarea>
                <div class="hint"><strong>Rappel :</strong> PBX = variation front-end. Ne demande pas de backend.</div>
              </div>
            </div>

            <!-- 4) Output -->
            <div class="section">
              <div class="shead">
                <div class="sleft">
                  <div class="sicon">‚ûç</div>
                  <div>
                    <p class="stitle">4) Output ‚Äî r√©sultat QA-friendly</p>
                    <p class="sdesc">Format clair = v√©rification rapide en Simulation Mode.</p>
                  </div>
                </div>
                <div class="stags">
                  <span class="tag req">Obligatoire</span>
                  <span class="tag">QA</span>
                </div>
              </div>

              <div class="row2">
                <div class="field">
                  <div class="label">
                    <span>Format attendu</span>
                    <span class="counter" id="c_format"></span>
                  </div>
                  <textarea id="format" placeholder="Ex : 1) R√©sum√© (1‚Äì2 phrases) 2) Changements exacts (liste) 3) Checklist QA (5 points max)."></textarea>
                </div>

                <div class="field">
                  <div class="label">
                    <span>Politique si info manquante</span>
                    <span class="help">anti-devinette</span>
                  </div>
                  <select id="missingPolicy">
                    <option value="ask" selected>Poser jusqu‚Äô√† 3 questions puis attendre</option>
                    <option value="assume">Faire jusqu‚Äô√† 3 hypoth√®ses explicites puis produire</option>
                  </select>
                  <div class="hint"><strong>Recommand√© :</strong> questions d‚Äôabord (√©conomie de cr√©dits).</div>
                </div>
              </div>

              <div class="row2">
                <div class="field">
                  <div class="label">
                    <span>Mode</span>
                    <span class="help">reco</span>
                  </div>
                  <select id="mode">
                    <option value="strict" selected>Strict (minimal, scop√©)</option>
                    <option value="creative">Cr√©atif (plus audacieux, toujours scop√©)</option>
                  </select>
                </div>

                <div class="field">
                  <div class="label">
                    <span>Exemples (optionnel)</span>
                    <span class="help">stabilise</span>
                  </div>
                  <textarea id="examples" placeholder="Bon : ‚ÄúVoir les prix‚Äù / √Ä √©viter : ‚ÄúAchetez maintenant !!!‚Äù"></textarea>
                </div>
              </div>
            </div>

            <!-- Result -->
            <div class="card">
              <div class="inner">
                <div class="resultHead">
                  <h3>Prompt √† coller dans PBX</h3>
                  <span class="badge" id="genBadge">Incomplet</span>
                </div>
                <textarea id="result" readonly placeholder="Clique ‚ÄúValider (questions)‚Äù ou ‚ÄúG√©n√©rer (PBX-ready)‚Äù."></textarea>
                <div class="toast" id="toast">Copi√© ‚úÖ</div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- SIDEBAR -->
      <div class="side">
        <div class="card">
          <div class="inner">
            <div class="qTop">
              <h3>Contr√¥le qualit√©</h3>
              <div class="scorePill" id="scorePill">0% ‚õî</div>
            </div>
            <div class="bar"><div id="scoreBar"></div></div>

            <div class="checks" id="checks"></div>

            <div class="actions">
              <button class="btn ghost" id="btnValidate" type="button">üß™ Valider le brief (questions)</button>
              <button class="btn primary" id="btnGenerate" type="button" disabled>‚öôÔ∏è G√©n√©rer le prompt (PBX-ready)</button>
              <button class="btn ghost" id="btnCopy" type="button" disabled>üìã Copier</button>
              <button class="btn danger" id="btnReset" type="button">üóëÔ∏è R√©initialiser</button>
            </div>

            <div class="mini">
              <strong>Valider</strong> produit des questions cibl√©es (max 3) si des infos manquent.<br>
              <strong>G√©n√©rer</strong> est bloqu√© tant que le brief n‚Äôest pas ‚ÄúPBX-ready‚Äù.
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  const fields = {
    goal: $("goal"),
    useCase: $("useCase"),
    page: $("page"),
    target: $("target"),
    identifier: $("identifier"),
    scope: $("scope"),

    variationType: $("variationType"),
    action: $("action"),
    hypothesis: $("hypothesis"),
    audience: $("audience"),
    data: $("data"),

    constraints: $("constraints"),
    avoid: $("avoid"),
    responsive: $("responsive"),
    style: $("style"),
    tech: $("tech"),

    format: $("format"),
    examples: $("examples"),
    missingPolicy: $("missingPolicy"),
    mode: $("mode"),

    result: $("result"),
    toast: $("toast"),

    btnValidate: $("btnValidate"),
    btnGenerate: $("btnGenerate"),
    btnCopy: $("btnCopy"),
    btnReset: $("btnReset"),

    scorePill: $("scorePill"),
    scoreBar: $("scoreBar"),
    checks: $("checks"),

    dotState: $("dotState"),
    stateLabel: $("stateLabel"),
    genBadge: $("genBadge"),

    respHelp: $("respHelp"),

    // counters
    c_goal: $("c_goal"),
    c_usecase: $("c_usecase"),
    c_page: $("c_page"),
    c_target: $("c_target"),
    c_scope: $("c_scope"),
    c_action: $("c_action"),
    c_audience: $("c_audience"),
    c_data: $("c_data"),
    c_constraints: $("c_constraints"),
    c_avoid: $("c_avoid"),
    c_format: $("c_format")
  };

  const KEY = "pbx_brief_quality_v3";

  function nonEmpty(v, min=10){ return (v || "").trim().length >= min; }

  const vagueMarkers = ["am√©liorer","optimiser","faire mieux","rendre plus","augmenter","peaufiner","comme tu veux","√† ta guise","peu importe"];
  function looksVague(text){
    if(!text) return true;
    const t = text.trim().toLowerCase();
    if(t.length < 28) return true;
    const hasV = vagueMarkers.some(m => t.includes(m));
    const hasConcrete = /(\d+)|(?:cta)|(?:headline)|(?:tableau)|(?:checklist)|(?:mots)|(?:caract)|(?:mobile)|(?:desktop)|(?:scope)|(?:aria)|(?:data-testid)/i.test(text);
    return hasV && !hasConcrete;
  }
  function multiObjective(text){
    if(!text) return false;
    const t = (" " + text.toLowerCase() + " ");
    const hits = [" et ", " puis ", " en m√™me temps ", " √† la fois ", " + "]
      .reduce((acc, k) => acc + (t.split(k).length - 1), 0);
    return hits >= 4;
  }
  function requiresResponsive(){
    const t = fields.variationType.value;
    return (t === "layout" || t === "visual" || t === "component");
  }

  function setCounter(el, value){
    const len = (value || "").trim().length;
    el.textContent = len ? `${len} car.` : "";
  }

  function computeQuality(){
    const missing = [];
    const warnings = [];

    // Use case
    if(!nonEmpty(fields.useCase.value, 18)){
      missing.push({k:"useCase", t:"Use case unique", d:"R√©√©cris en 1 phrase / 1 objectif.", f:"Ex : ‚ÄúChanger le CTA du pricing teaser pour augmenter le clic.‚Äù"});
    } else if(multiObjective(fields.useCase.value)){
      warnings.push({k:"useCase", t:"Use case potentiellement multiple", d:"On d√©tecte plusieurs objectifs.", f:"D√©coupe en 2 prompts (1 variation = 1 objectif)."});
    }

    // Where
    const hasLocation = nonEmpty(fields.page.value, 6) || nonEmpty(fields.scope.value, 24);
    if(!hasLocation){
      missing.push({k:"where", t:"Where (page/emplacement)", d:"Indique l‚ÄôURL/route ou l‚Äôemplacement pr√©cis.", f:"Ex : ‚Äú/ ‚Äî section pricing teaser avant FAQ.‚Äù"});
    }
    if(!nonEmpty(fields.target.value, 16)){
      missing.push({k:"target", t:"Cible pr√©cise", d:"Indique l‚Äô√©l√©ment exact (1 principal).", f:"Ex : ‚Äúlibell√© du CTA du bloc pricing‚Äù."});
    }
    if(!nonEmpty(fields.identifier.value, 8)){
      warnings.push({k:"identifier", t:"Identifiant stable (reco)", d:"Stabilise l‚Äôapplication de la variation.", f:"aria-label / data-testid / texte exact."});
    }
    if(!nonEmpty(fields.scope.value, 18)){
      warnings.push({k:"scope", t:"Scope (reco)", d:"√âvite que PBX d√©borde sur d‚Äôautres zones.", f:"Ex : ‚Äúne modifier que le CTA + sous-texte‚Äù."});
    }

    // What
    if(!nonEmpty(fields.action.value, 28) || looksVague(fields.action.value)){
      missing.push({k:"what", t:"What (changement exact)", d:"D√©cris le changement concret √† produire.", f:"Ex : ‚ÄúRemplacer le CTA par 2‚Äì4 mots, b√©n√©fice, plus explicite.‚Äù"});
    }

    // How
    const hasRules = nonEmpty(fields.constraints.value, 12) || nonEmpty(fields.avoid.value, 8);
    if(!hasRules){
      missing.push({k:"constraints", t:"Contraintes", d:"Ajoute au moins 1 hard rule + 1 interdit.", f:"Ex : FR, 2‚Äì4 mots, pas d‚Äôemoji; √©viter ‚Äòacheter‚Äô."});
    }

    if(requiresResponsive() && !nonEmpty(fields.responsive.value, 14)){
      missing.push({k:"responsive", t:"Responsive", d:"Obligatoire pour layout/visuel/composant.", f:"Ex : desktop+mobile, ne pas casser la grille, conserver spacing."});
    }

    // Output
    if(!nonEmpty(fields.format.value, 22)){
      missing.push({k:"format", t:"Format exploitable", d:"Impose un format QA-friendly.", f:"R√©sum√© + changements exacts + checklist QA (5 points)."});
    }

    // KPI is a warning (reco)
    if(!nonEmpty(fields.goal.value, 14)){
      warnings.push({k:"goal", t:"KPI / succ√®s (reco)", d:"Ajoute un KPI pour aligner l‚Äôangle.", f:"CTR CTA / conversion / abandon / clart√© / confiance."});
    }

    // Backend smell
    if(/backend|serveur|api|permission|database|bdd|auth|paiement|pricing engine|business rule/i.test(
      (fields.tech.value||"") + " " + (fields.action.value||"")
    )){
      warnings.push({k:"backend", t:"Risque backend", d:"PBX ne g√®re pas la logique serveur.", f:"Reste sur UI/copy/layout front-end scop√©."});
    }

    // score
    let score = 100;
    score -= missing.length * 18;
    score -= warnings.length * 6;
    score = Math.max(0, Math.min(100, score));

    const ready = (missing.length === 0 && score >= 74);
    const state = ready ? "ready" : (score >= 58 ? "warn" : "bad");
    return {score, ready, state, missing, warnings};
  }

  function renderChecks(q){
    const items = [];
    const add = (state, title, desc) => {
      const icon = state === "ok" ? "‚úì" : (state === "warn" ? "!" : "√ó");
      items.push(`
        <div class="item ${state}">
          <div class="ico">${icon}</div>
          <div>
            <p class="itT">${title}</p>
            <p class="itD">${desc}</p>
          </div>
        </div>
      `);
    };

    const okUseCase = nonEmpty(fields.useCase.value, 18) && !multiObjective(fields.useCase.value);
    add(okUseCase ? "ok" : (nonEmpty(fields.useCase.value, 18) ? "warn" : "bad"),
        "Use case unique",
        okUseCase ? "OK ‚Äî 1 variation = 1 objectif." : "R√©√©cris en 1 phrase / 1 objectif.");

    const hasLocation = nonEmpty(fields.page.value, 6) || nonEmpty(fields.scope.value, 24);
    add(hasLocation ? "ok" : "bad",
        "Where (page/emplacement)",
        hasLocation ? "OK ‚Äî la page/emplacement est d√©fini." : "Ajoute URL/route ou emplacement pr√©cis.");

    const okTarget = nonEmpty(fields.target.value, 16);
    add(okTarget ? "ok" : "bad",
        "Target pr√©cis",
        okTarget ? "OK ‚Äî √©l√©ment principal d√©fini." : "Indique l‚Äô√©l√©ment exact (CTA label / H1 / microcopy).");

    const okIdentifier = nonEmpty(fields.identifier.value, 8);
    add(okIdentifier ? "ok" : "warn",
        "Identifiant stable (reco)",
        okIdentifier ? "OK ‚Äî plus robuste." : "Ajoute aria-label / data-testid / texte exact.");

    const okWhat = nonEmpty(fields.action.value, 28) && !looksVague(fields.action.value);
    add(okWhat ? "ok" : "bad",
        "What (changement concret)",
        okWhat ? "OK ‚Äî action exploitable." : "D√©cris le changement concret (pas ‚Äúoptimiser‚Äù).");

    const okRules = nonEmpty(fields.constraints.value, 12) || nonEmpty(fields.avoid.value, 8);
    add(okRules ? "ok" : "bad",
        "Contraintes / interdits",
        okRules ? "OK ‚Äî garde-fous pr√©sents." : "Ajoute hard rules + ban list.");

    const okResp = !requiresResponsive() || nonEmpty(fields.responsive.value, 14);
    add(okResp ? "ok" : "bad",
        "Responsive",
        okResp ? (requiresResponsive() ? "OK ‚Äî contraintes mobile/desktop." : "N/A (copy)." ) : "Obligatoire si layout/visuel/composant.");

    const okFormat = nonEmpty(fields.format.value, 22);
    add(okFormat ? "ok" : "bad",
        "Output QA-friendly",
        okFormat ? "OK ‚Äî v√©rifiable en simulation." : "Impose r√©sum√© + changements + checklist QA.");

    add(nonEmpty(fields.goal.value, 14) ? "ok" : "warn",
        "KPI / succ√®s (reco)",
        nonEmpty(fields.goal.value, 14) ? "OK ‚Äî variation align√©e." : "Ajoute un KPI (CTR, conversion, abandon‚Ä¶).");

    fields.checks.innerHTML = items.join("");
  }

  function updateResponsiveHint(){
    fields.respHelp.textContent = requiresResponsive()
      ? "obligatoire (car layout/visuel/composant)"
      : "recommand√© (copy-only)";
  }

  function toast(msg){
    fields.toast.textContent = msg;
    fields.toast.style.display = "block";
    setTimeout(()=> fields.toast.style.display="none", 2000);
  }

  function save(){
    const payload = {};
    Object.keys(fields).forEach(k=>{
      const el = fields[k];
      if(!el) return;
      if(el.tagName === "TEXTAREA" || el.tagName === "INPUT" || el.tagName === "SELECT"){
        payload[k] = el.value;
      }
    });
    try{ localStorage.setItem(KEY, JSON.stringify(payload)); }catch(e){}
  }
  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return;
      const payload = JSON.parse(raw);
      Object.keys(payload).forEach(k=>{
        if(fields[k] && (fields[k].tagName==="TEXTAREA" || fields[k].tagName==="INPUT" || fields[k].tagName==="SELECT")){
          fields[k].value = payload[k];
        }
      });
    }catch(e){}
  }
  function clearStore(){ try{ localStorage.removeItem(KEY);}catch(e){} }

  function buildValidation(q){
    const need = new Set(q.missing.map(m=>m.k));
    const questions = [];
    const ask = (qtext, why, example) => {
      if(questions.length >= 3) return;
      questions.push(`- ${qtext}\n  - Pourquoi : ${why}\n  - Exemple : ${example}`);
    };

    // Priority PBX
    if(need.has("useCase")){
      ask("Quel est l‚Äôobjectif UNIQUE de cette variation (1 phrase) ?",
          "PBX suit mieux une intention unique.",
          "‚ÄúChanger le CTA du bloc pricing pour augmenter le clic vers /pricing.‚Äù");
    }
    if(need.has("where")){
      ask("Sur quelle page (URL/route) et o√π se trouve l‚Äô√©l√©ment ?",
          "PBX doit savoir o√π appliquer le changement.",
          "‚Äú/ ‚Äî section pricing teaser juste avant la FAQ.‚Äù");
    }
    if(need.has("target")){
      ask("Quel est l‚Äô√©l√©ment exact √† modifier (1 principal) ?",
          "Une cible floue fait d√©river la variation.",
          "‚ÄúTexte du bouton CTA du bloc pricing (libell√© uniquement).‚Äù");
    }
    if(need.has("what")){
      ask("Quel changement concret veux-tu (what) ?",
          "Un livrable concret √©vite les r√©ponses g√©n√©riques.",
          "‚ÄúRemplacer le CTA par 2‚Äì4 mots, b√©n√©fice, plus explicite.‚Äù");
    }
    if(need.has("constraints")){
      ask("Quelles contraintes / interdits non n√©gociables ?",
          "Les garde-fous √©vitent une variation inutilisable.",
          "‚ÄúFR, 2‚Äì4 mots, pas d‚Äôemoji; √©viter ‚Äòacheter‚Äô.‚Äù");
    }
    if(need.has("responsive")){
      ask("Quelles contraintes responsive (desktop+mobile) ?",
          "Les variations layout/visuelles cassent souvent le responsive.",
          "‚ÄúNe pas casser la grille; conserver spacing; mobile prioritaire.‚Äù");
    }
    if(need.has("format")){
      ask("Quel format de sortie QA-friendly veux-tu ?",
          "Un format impos√© rend la v√©rification imm√©diate.",
          "‚ÄúR√©sum√© + changements exacts + checklist QA (5 points max).‚Äù");
    }

    if(questions.length === 0){
      questions.push("- Ton brief est complet ‚úÖ\n  - Pourquoi : where/target/what/constraints/output sont pr√©sents.");
    }

    const policy = fields.missingPolicy.value === "ask"
      ? "Poser jusqu‚Äô√† 3 questions puis attendre."
      : "Faire jusqu‚Äô√† 3 hypoth√®ses explicites puis produire.";

    return `
üß™ Validation du brief (anti-cr√©dits)

√âtat : ${q.ready ? "‚úÖ Brief pr√™t" : "‚õî Brief incomplet"}
Score : ${q.score}%
Politique manques : ${policy}

Questions √† clarifier (max 3) :
${questions.join("\n\n")}

Ensuite : clique ‚ÄúG√©n√©rer le prompt (PBX-ready)‚Äù.
`.trim();
  }

  function buildFinalPrompt(){
    const mode = fields.mode.value;
    const missingPolicy = fields.missingPolicy.value;

    const creativeNote = mode === "creative"
      ? "Be more audacious/creative while staying strictly within scope and constraints."
      : "Stay minimal and scoped. Prefer the smallest change likely to impact the KPI.";

    const mustAsk = missingPolicy === "ask"
      ? "If critical information is missing, ask up to 3 questions and WAIT."
      : "If critical information is missing, make up to 3 explicit assumptions, then proceed.";

    const where = [
      `Page/route: ${fields.page.value.trim() || "(not provided; see scope)"}`,
      `Target element: ${fields.target.value.trim()}`,
      fields.identifier.value.trim() ? `Stable identifier(s): ${fields.identifier.value.trim()}` : "Stable identifier(s): (not provided ‚Äî use visible text or accessibility attributes if possible)",
      `Allowed scope: ${fields.scope.value.trim() || "Only modify the target element and its immediate container. Do not change unrelated sections."}`
    ].join("\n");

    const what = [
      `Variation type: ${fields.variationType.value}`,
      `Exact change (WHAT): ${fields.action.value.trim()}`,
      fields.hypothesis.value.trim() ? `Hypothesis: ${fields.hypothesis.value.trim()}` : null,
      fields.goal.value.trim() ? `Primary KPI/goal: ${fields.goal.value.trim()}` : null,
      fields.audience.value.trim() ? `Audience/context: ${fields.audience.value.trim()}` : null,
      fields.data.value.trim() ? `Useful info (value prop/proof/objections): ${fields.data.value.trim()}` : null
    ].filter(Boolean).join("\n");

    const how = [
      "Hard constraints:",
      fields.constraints.value.trim() ? `- ${fields.constraints.value.trim().split("\n").map(s=>s.trim()).filter(Boolean).join("\n- ")}` : "- (none provided)",
      "",
      "Avoid:",
      fields.avoid.value.trim() ? `- ${fields.avoid.value.trim().split("\n").map(s=>s.trim()).filter(Boolean).join("\n- ")}` : "- (none provided)",
      "",
      `Responsive requirements: ${requiresResponsive() ? (fields.responsive.value.trim() || "(not provided)") : "N/A (copy-only)"}`,
      fields.style.value.trim() ? `Brand/style: ${fields.style.value.trim()}` : null,
      fields.tech.value.trim() ? `Technical constraints (front-end only): ${fields.tech.value.trim()}` : null,
    ].filter(Boolean).join("\n");

    const output = fields.format.value.trim();

    const prompt =
`You are helping create a single PBX AI-generated variation on an existing webpage (front-end only).
No back-end changes. Do not propose server logic, permissions, payment rules, or database changes.

${mustAsk}

${creativeNote}

## WHERE
${where}

## WHAT
${what}

## HOW
${how}

## OUTPUT FORMAT (mandatory)
${output}

Final instruction:
- Produce ONE variation only (do not generate multiple alternatives).
- Keep changes strictly within the allowed scope.
- End with a short QA checklist (max 5 bullets) to verify in simulation mode.`;

    return prompt.trim();
  }

  async function copyResult(){
    const v = fields.result.value.trim();
    if(!v) return;
    try{
      await navigator.clipboard.writeText(v);
      toast("Copi√© ‚úÖ");
    }catch(e){
      fields.result.select();
      document.execCommand("copy");
      toast("Copi√© ‚úÖ");
    }
    fields.btnCopy.disabled = false;
  }

  function updateUI(){
    updateResponsiveHint();

    // counters
    setCounter(fields.c_goal, fields.goal.value);
    setCounter(fields.c_usecase, fields.useCase.value);
    setCounter(fields.c_page, fields.page.value);
    setCounter(fields.c_target, fields.target.value);
    setCounter(fields.c_scope, fields.scope.value);
    setCounter(fields.c_action, fields.action.value);
    setCounter(fields.c_audience, fields.audience.value);
    setCounter(fields.c_data, fields.data.value);
    setCounter(fields.c_constraints, fields.constraints.value);
    setCounter(fields.c_avoid, fields.avoid.value);
    setCounter(fields.c_format, fields.format.value);

    const q = computeQuality();

    fields.scorePill.textContent = `${q.score}% ${q.ready ? "‚úÖ" : "‚õî"}`;
    fields.scoreBar.style.width = `${q.score}%`;

    if(q.state === "ready"){
      fields.scoreBar.style.background = "linear-gradient(90deg, #22C55E, #14B8A6)";
      fields.dotState.style.background = "var(--good)";
      fields.stateLabel.textContent = "Brief pr√™t (PBX-ready)";
      fields.genBadge.textContent = "PBX-ready";
    } else if(q.state === "warn"){
      fields.scoreBar.style.background = "linear-gradient(90deg, #F59E0B, #FBBF24)";
      fields.dotState.style.background = "var(--warn)";
      fields.stateLabel.textContent = "Presque pr√™t";
      fields.genBadge.textContent = "Incomplet";
    } else {
      fields.scoreBar.style.background = "linear-gradient(90deg, #EF4444, #F97316)";
      fields.dotState.style.background = "var(--bad)";
      fields.stateLabel.textContent = "Brief incomplet";
      fields.genBadge.textContent = "Incomplet";
    }

    renderChecks(q);

    fields.btnGenerate.disabled = !q.ready;
    fields.btnCopy.disabled = !fields.result.value.trim();

    save();
    return q;
  }

  function renderChecks(q){
    // (same UI layout as screenshot)
    const items = [];
    const add = (state, title, desc) => {
      const icon = state === "ok" ? "‚úì" : (state === "warn" ? "!" : "√ó");
      items.push(`
        <div class="item ${state}">
          <div class="ico">${icon}</div>
          <div>
            <p class="itT">${title}</p>
            <p class="itD">${desc}</p>
          </div>
        </div>
      `);
    };

    const okUseCase = nonEmpty(fields.useCase.value, 18) && !multiObjective(fields.useCase.value);
    add(okUseCase ? "ok" : (nonEmpty(fields.useCase.value, 18) ? "warn" : "bad"),
        "Use case unique",
        okUseCase ? "OK ‚Äî 1 variation = 1 objectif." : "R√©√©cris en 1 phrase / 1 objectif.");

    const hasLocation = nonEmpty(fields.page.value, 6) || nonEmpty(fields.scope.value, 24);
    add(hasLocation ? "ok" : "bad",
        "Where (page/emplacement)",
        hasLocation ? "OK ‚Äî page/emplacement d√©fini." : "Ajoute URL/route ou emplacement pr√©cis.");

    const okTarget = nonEmpty(fields.target.value, 16);
    add(okTarget ? "ok" : "bad",
        "Target pr√©cis",
        okTarget ? "OK ‚Äî √©l√©ment principal d√©fini." : "Ex : ‚Äúlibell√© du CTA du bloc pricing‚Äù.");

    const okIdentifier = nonEmpty(fields.identifier.value, 8);
    add(okIdentifier ? "ok" : "warn",
        "Identifiant stable (reco)",
        okIdentifier ? "OK ‚Äî plus robuste." : "Ex : aria-label / data-testid / texte exact.");

    const okWhat = nonEmpty(fields.action.value, 28) && !looksVague(fields.action.value);
    add(okWhat ? "ok" : "bad",
        "What (changement concret)",
        okWhat ? "OK ‚Äî variation d√©crite." : "D√©cris le changement concret (pas ‚Äúoptimiser‚Äù).");

    const okRules = nonEmpty(fields.constraints.value, 12) || nonEmpty(fields.avoid.value, 8);
    add(okRules ? "ok" : "bad",
        "Contraintes",
        okRules ? "OK ‚Äî garde-fous pr√©sents." : "Ajoute au moins 1 hard rule + ban list.");

    const okResp = !requiresResponsive() || nonEmpty(fields.responsive.value, 14);
    add(okResp ? "ok" : "bad",
        "Responsive",
        okResp ? (requiresResponsive() ? "OK ‚Äî mobile/desktop cadr√©." : "N/A (copy-only).") : "Obligatoire si layout/visuel/composant.");

    const okFormat = nonEmpty(fields.format.value, 22);
    add(okFormat ? "ok" : "bad",
        "Format exploitable",
        okFormat ? "OK ‚Äî QA-friendly." : "Ex : r√©sum√© + changements + checklist QA.");

    add(nonEmpty(fields.goal.value, 14) ? "ok" : "warn",
        "KPI / succ√®s (reco)",
        nonEmpty(fields.goal.value, 14) ? "OK ‚Äî variation align√©e." : "Ajoute un KPI (CTR, conversion, abandon‚Ä¶).");

    fields.checks.innerHTML = items.join("");
  }

  function validateBrief(){
    const q = updateUI();
    fields.result.value = buildValidation(q);
    fields.btnCopy.disabled = !fields.result.value.trim();
    toast("Questions g√©n√©r√©es ‚úÖ");
  }

  function generatePrompt(){
    const q = updateUI();
    if(!q.ready) return;
    fields.result.value = buildFinalPrompt();
    fields.btnCopy.disabled = !fields.result.value.trim();
    toast("Prompt g√©n√©r√© ‚úÖ");
  }

  function resetAll(){
    const ok = confirm("R√©initialiser tous les champs ?");
    if(!ok) return;
    [
      "goal","useCase","page","target","identifier","scope",
      "variationType","action","hypothesis","audience","data",
      "constraints","avoid","responsive","style","tech",
      "format","examples","missingPolicy","mode"
    ].forEach(id=>{
      const el = $(id);
      if(!el) return;
      if(el.tagName === "SELECT"){
        if(id === "variationType") el.value = "copy";
        else if(id === "missingPolicy") el.value = "ask";
        else if(id === "mode") el.value = "strict";
        else el.value = el.options[0]?.value ?? "";
      }else{
        el.value = "";
      }
    });
    fields.result.value = "";
    clearStore();
    updateUI();
  }

  // Keyboard shortcut
  document.addEventListener("keydown", (e)=>{
    const isMac = navigator.platform.toUpperCase().includes("MAC");
    const ctrl = isMac ? e.metaKey : e.ctrlKey;
    if(ctrl && e.key === "Enter"){
      e.preventDefault();
      if(!fields.btnGenerate.disabled) generatePrompt();
      else validateBrief();
    }
  });

  // Watchers
  const watchIds = [
    "goal","useCase","page","target","identifier","scope",
    "variationType","action","hypothesis","audience","data",
    "constraints","avoid","responsive","style","tech",
    "format","examples","missingPolicy","mode"
  ];
  watchIds.forEach(id=>{
    const el = $(id);
    el.addEventListener("input", updateUI);
    el.addEventListener("change", updateUI);
  });

  fields.btnValidate.addEventListener("click", validateBrief);
  fields.btnGenerate.addEventListener("click", generatePrompt);
  fields.btnCopy.addEventListener("click", copyResult);
  fields.btnReset.addEventListener("click", resetAll);

  // Init
  load();
  updateUI();

  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return;
      const payload = JSON.parse(raw);
      Object.keys(payload).forEach(k=>{
        const el = fields[k];
        if(el && (el.tagName==="TEXTAREA" || el.tagName==="INPUT" || el.tagName==="SELECT")){
          el.value = payload[k];
        }
      });
    }catch(e){}
  }
</script>
</body>
</html>
