<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PBX Prompt Builder — Formulaire (Contexte / Où / Quoi / Limites / Approche)</title>
  <style>
    :root{
      --bg:#F6F7FB;
      --card:#FFFFFF;
      --ink:#0F172A;
      --muted:#64748B;
      --muted2:#94A3B8;
      --line:#E2E8F0;

      --primary:#6D28D9;
      --teal:#14B8A6;

      --good:#22C55E;
      --warn:#F59E0B;
      --bad:#EF4444;

      --shadow2: 0 10px 26px rgba(15, 23, 42, 0.07);

      --r:18px;
    }

    *{ box-sizing:border-box; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", sans-serif; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 520px at 15% -10%, rgba(109,40,217,0.16), transparent 55%),
        radial-gradient(1200px 520px at 85% -10%, rgba(20,184,166,0.14), transparent 55%),
        var(--bg);
      color:var(--ink);
      min-height:100vh;
      padding: 20px 14px 46px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }

    .wrap{ width:100%; max-width: 1200px; }

    /* Header */
    .top{
      display:flex;
      gap:14px;
      justify-content:space-between;
      align-items:flex-start;
      flex-wrap:wrap;
      margin-bottom: 14px;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:flex-start;
      min-width: 280px;
      flex: 1 1 740px;
    }
    .logo{
      width:44px; height:44px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--primary), var(--teal));
      box-shadow: var(--shadow2);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:950;
      letter-spacing:-0.3px;
      flex-shrink:0;
    }
    h1{
      margin:0;
      font-size: 22px;
      letter-spacing:-0.2px;
      line-height:1.2;
    }
    .sub{
      margin:5px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height:1.35;
      max-width: 960px;
    }

    .metaPills{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      flex: 1 1 360px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,0.88);
      box-shadow: 0 10px 22px rgba(15,23,42,0.05);
      font-size: 12.5px;
      color: var(--muted);
      white-space:nowrap;
    }
    .dot{
      width:9px; height:9px; border-radius:999px;
      background: var(--muted2);
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1fr 380px;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 1020px){
      .grid{ grid-template-columns: 1fr; }
      .side{ position: static !important; }
    }

    .card{
      background: rgba(255,255,255,0.92);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow2);
    }
    .card .inner{ padding: 16px; }

    /* Form blocks */
    .hero{
      border: 1px solid var(--line);
      border-radius: 18px;
      background: rgba(255,255,255,0.78);
      padding: 14px;
      margin-bottom: 12px;
    }
    .heroHead{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .heroLeft{ display:flex; gap:10px; align-items:flex-start; }
    .heroIcon{
      width:36px; height:36px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(109,40,217,0.12), rgba(20,184,166,0.12));
      border: 1px solid rgba(109,40,217,0.18);
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--primary);
      font-weight: 950;
      flex-shrink:0;
    }
    .heroTitle{ margin:0; font-size: 14px; font-weight: 950; letter-spacing:-0.15px; }
    .heroDesc{ margin:3px 0 0; font-size: 12.5px; color: var(--muted); line-height:1.35; }

    .tags{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .tag{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--muted);
      white-space:nowrap;
    }
    .tag.req{
      border-color: rgba(239,68,68,0.22);
      background: rgba(239,68,68,0.06);
      color: #991B1B;
      font-weight: 900;
    }

    .label{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin: 10px 0 6px;
    }
    .label span{
      font-size: 12.7px;
      font-weight: 950;
      letter-spacing:-0.1px;
    }
    .counter{ font-size: 11.7px; color: var(--muted2); white-space:nowrap; }

    textarea{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(248,250,252,0.85);
      padding: 11px 12px;
      font-size: 13.8px;
      outline:none;
      transition: border-color .15s, box-shadow .15s, background .15s;
      line-height: 1.35;
      min-height: 120px;
      resize: vertical;
    }
    textarea:focus{
      border-color: rgba(109,40,217,0.55);
      box-shadow: 0 0 0 3px rgba(109,40,217,0.18);
      background: #fff;
    }

    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 860px){ .row2{ grid-template-columns: 1fr; } }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top: 10px;
    }
    .chip{
      border: 1px solid var(--line);
      background: #fff;
      color: var(--ink);
      font-weight: 900;
      font-size: 12.5px;
      padding: 8px 10px;
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 8px 18px rgba(15,23,42,0.04);
      transition: transform .06s ease, border-color .15s ease;
    }
    .chip:active{ transform: translateY(1px); }
    .chip:hover{ border-color: rgba(109,40,217,0.35); }

    .hint{
      margin-top: 10px;
      padding: 10px 11px;
      border-radius: 14px;
      border: 1px dashed rgba(100,116,139,0.24);
      background: rgba(2,6,23,0.03);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .hint strong{ color: var(--ink); }

    /* Sidebar */
    .side{ position: sticky; top: 14px; }

    .qTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom: 10px;
    }
    .qTop h3{
      margin:0;
      font-size: 14px;
      font-weight: 950;
      letter-spacing:-0.15px;
    }
    .scorePill{
      font-size: 12.5px;
      font-weight: 950;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--muted);
      white-space:nowrap;
    }
    .bar{
      height: 10px;
      background: #E2E8F0;
      border-radius: 999px;
      overflow:hidden;
      margin-bottom: 10px;
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: var(--good);
      transition: width .2s ease, background .2s ease;
    }

    .explain{
      margin-top: 10px;
      padding: 10px 11px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.86);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .explain strong{ color: var(--ink); }

    .checks{
      display:grid;
      gap:10px;
      margin-top: 10px;
    }
    .item{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.86);
    }
    .ico{
      width:26px; height:26px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight: 950;
      flex-shrink:0;
      background: var(--muted2);
    }
    .item.ok .ico{ background: var(--good); }
    .item.warn .ico{ background: var(--warn); }
    .item.bad .ico{ background: var(--bad); }

    .itT{ margin:0; font-size: 12.6px; font-weight: 950; letter-spacing:-0.1px; }
    .itD{ margin: 2px 0 0; font-size: 12px; color: var(--muted); line-height:1.35; }

    .divider{
      margin: 12px 0;
      height: 1px;
      background: var(--line);
    }

    /* Result */
    .resultHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 8px;
    }
    .resultHead h3{
      margin:0;
      font-size: 14px;
      font-weight: 950;
      letter-spacing:-0.15px;
    }
    .badge{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--muted);
      white-space:nowrap;
    }
    #result{
      width:100%;
      min-height: 240px;
      border-radius: 16px;
      border: none;
      outline:none;
      padding: 12px 12px;
      background: #020617;
      color: #E5E7EB;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12.8px;
      line-height: 1.45;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">PBX</div>
        <div>
          <h1>PBX Prompt Builder — Formulaire</h1>
          <p class="sub">
            Objectif : produire un prompt PBX <strong>réplicable</strong> et <strong>robuste</strong> (Contexte / Où / Quoi / Limites / Approche).
            Le score explique <strong>ce qui manque</strong> pour être “PBX-ready”.
          </p>
        </div>
      </div>

      <div class="metaPills">
        <div class="pill"><span class="dot" id="dotState"></span><span id="stateLabel">Prompt incomplet</span></div>
      </div>
    </div>

    <div class="grid">
      <!-- MAIN -->
      <div>
        <div class="card">
          <div class="inner">

            <!-- Contexte -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">①</div>
                  <div>
                    <p class="heroTitle">Contexte</p>
                    <p class="heroDesc"><strong>Attendu :</strong> URL + type de page + états à couvrir (initial / après clic / overlay / lazy-load).</p>
                  </div>
                </div>
                <div class="tags">
                  <span class="tag req">Obligatoire</span>
                </div>
              </div>
              <div class="label">
                <span>Contexte</span>
                <span class="counter" id="c_context"></span>
              </div>
              <textarea id="context" placeholder="Ex : URL: https://… / listing. Tuiles présentes au chargement + ajoutées après clic “voir tout”. Overlay détail s’ouvre/ferme."></textarea>
              <div class="hint"><strong>Astuce :</strong> mentionne “dynamique / overlay / voir tout” si c’est le cas.</div>
            </div>

            <!-- Où -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">②</div>
                  <div>
                    <p class="heroTitle">Où ?</p>
                    <p class="heroDesc"><strong>Attendu :</strong> cibler <u>l’élément</u> et/ou la <u>position exacte</u> de la modification (dans la tuile, au-dessus du prix, sous l’image…).</p>
                  </div>
                </div>
                <div class="tags">
                  <span class="tag req">Obligatoire</span>
                </div>
              </div>
              <div class="label">
                <span>Où (cible + position)</span>
                <span class="counter" id="c_where"></span>
              </div>
              <textarea id="where" placeholder="Ex : Cible : tuiles “iPhone 17”, “iPhone 17 Pro”, “iPhone 17 Pro Max”. Position : sous l’image du téléphone, centré."></textarea>

              <div class="chips" aria-label="Exemples rapides (Où)">
                <div class="chip" data-target="where" data-add="Cible : toutes les tuiles forfaits visibles au chargement + celles ajoutées via “voir tout” + celles dans l’overlay “voir le détail”. Position : la ligne de texte juste au-dessus du prix.">Tuiles + overlay</div>
                <div class="chip" data-target="where" data-add="Dans chaque tuile, cibler la ligne de texte située juste au-dessus du prix affiché (bloc prix).">Texte au-dessus du prix</div>
                <div class="chip" data-target="where" data-add="Sous l’image produit dans la tuile, aligné au centre, dans le même conteneur que le titre/sous-titre.">Sous image, centré</div>
              </div>
            </div>

            <!-- Quoi -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">③</div>
                  <div>
                    <p class="heroTitle">Quoi ?</p>
                    <p class="heroDesc"><strong>Attendu :</strong> séparer <u>l’action</u> (Add/Replace/Transform/Calculate) du <u>contenu</u> (texte exact, format, formule).</p>
                  </div>
                </div>
                <div class="tags">
                  <span class="tag req">Obligatoire</span>
                </div>
              </div>

              <div class="row2">
                <div>
                  <div class="label">
                    <span>Action</span>
                    <span class="counter" id="c_action"></span>
                  </div>
                  <textarea id="action" placeholder="Ex : Ajouter un message / Remplacer la ligne au-dessus du prix / Calculer et afficher le prix total."></textarea>
                </div>
                <div>
                  <div class="label">
                    <span>Contenu (texte exact / format / formule)</span>
                    <span class="counter" id="c_content"></span>
                  </div>
                  <textarea id="content" placeholder="Ex : “À partir d’1€ …” OU format “9,99€/mois” où 9,99 = prix + |remise|."></textarea>
                </div>
              </div>

              <div class="hint">
                <strong>Si calcul :</strong> valeurs à extraire + formule + format final. <strong>Si remplacement :</strong> “uniquement X, ne pas toucher à Y”.
              </div>
            </div>

            <!-- Limites -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">④</div>
                  <div>
                    <p class="heroTitle">Limites</p>
                    <p class="heroDesc"><strong>Attendu :</strong> ce qui ne doit pas bouger (charte, fond greige, typographies, layout) + règles de style.</p>
                  </div>
                </div>
                <div class="tags">
                  <span class="tag">Recommandé</span>
                </div>
              </div>
              <div class="label">
                <span>Limites / contraintes</span>
                <span class="counter" id="c_limits"></span>
              </div>
              <textarea id="limits" placeholder="Ex : Respecter fond greige + typographie. Ne pas modifier la grille/layout. Le message doit rester lisible sans dénaturer."></textarea>
            </div>

            <!-- Approche -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">⑤</div>
                  <div>
                    <p class="heroTitle">Approche</p>
                    <p class="heroDesc"><strong>Attendu :</strong> robustesse (dynamique/overlay), ré-application, idempotence (pas de doublons), fallback sans erreur.</p>
                  </div>
                </div>
                <div class="tags">
                  <span class="tag">Recommandé</span>
                </div>
              </div>
              <div class="label">
                <span>Approche technique</span>
                <span class="counter" id="c_approach"></span>
              </div>
              <textarea id="approach" placeholder="Ex : Appliquer au chargement + réappliquer sur ajouts DOM (MutationObserver). Idempotent (data-processed). Fonctionner dans l’overlay. Fallback : ne rien faire si cible introuvable."></textarea>

              <div class="chips" aria-label="Exemples rapides (Approche)">
                <div class="chip" data-target="approach" data-add="Appliquer au chargement initial + réappliquer sur ajouts DOM via MutationObserver. Idempotent : ne jamais dupliquer (data-processed).">MutationObserver + idempotent</div>
                <div class="chip" data-target="approach" data-add="Écouter les clics sur “voir tout” et “voir le détail”, puis relancer apply() après rendu. Maintenir le comportement après ouverture/fermeture d’overlay.">Clics + overlays</div>
                <div class="chip" data-target="approach" data-add="Fallback : si l’élément attendu est absent ou non parsable, ne rien modifier et ne pas générer d’erreur console.">Fallback safe</div>
              </div>
            </div>

            <!-- Vérification -->
            <div class="hero">
              <div class="heroHead">
                <div class="heroLeft">
                  <div class="heroIcon">⑥</div>
                  <div>
                    <p class="heroTitle">Vérification attendue</p>
                    <p class="heroDesc"><strong>Attendu :</strong> critères visibles (persistance après interactions, overlay, style barré/gris, etc.).</p>
                  </div>
                </div>
                <div class="tags">
                  <span class="tag">Optionnel</span>
                </div>
              </div>
              <div class="label">
                <span>Vérification</span>
                <span class="counter" id="c_verify"></span>
              </div>
              <textarea id="verify" placeholder="Ex : Le texte reste présent après interactions. Dans l’overlay, il est visible. Si prix calculé : barré + gris partout."></textarea>
            </div>

          </div>
        </div>
      </div>

      <!-- SIDEBAR -->
      <div class="side">
        <div class="card">
          <div class="inner">
            <div class="qTop">
              <h3>Contrôle qualité</h3>
              <div class="scorePill" id="scorePill">0% ⛔</div>
            </div>
            <div class="bar"><div id="scoreBar"></div></div>

            <div class="explain" id="explainBox">
              <strong>Comment le score est calculé</strong><br>
              • <strong>Contexte / Où / Action / Contenu</strong> sont requis (sinon score ↓ fort).<br>
              • <strong>Limites</strong> et <strong>Approche</strong> sont recommandés (score ↓ modéré).<br>
              • Si le contexte mentionne <em>overlay/dynamique</em>, l’<strong>Approche</strong> devient quasi indispensable.
            </div>

            <div class="checks" id="checks"></div>

            <div class="divider"></div>

            <!-- Prompt prêt à coller en dernière position de la sidebar -->
            <div class="resultHead">
              <h3>Prompt PBX prêt à coller</h3>
              <span class="badge" id="genBadge">Incomplet</span>
            </div>
            <textarea id="result" readonly></textarea>

          </div>
        </div>
      </div>

    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);
  const SKEY = "pbx_prompt_form_v4_no_cta";

  const els = {
    context: $("context"),
    where: $("where"),
    action: $("action"),
    content: $("content"),
    limits: $("limits"),
    approach: $("approach"),
    verify: $("verify"),

    result: $("result"),

    scorePill: $("scorePill"),
    scoreBar: $("scoreBar"),
    checks: $("checks"),

    dotState: $("dotState"),
    stateLabel: $("stateLabel"),
    genBadge: $("genBadge"),

    c_context: $("c_context"),
    c_where: $("c_where"),
    c_action: $("c_action"),
    c_content: $("c_content"),
    c_limits: $("c_limits"),
    c_approach: $("c_approach"),
    c_verify: $("c_verify"),
  };

  const vagueMarkers = [
    "améliorer","optimiser","faire mieux","rendre plus","peaufiner","comme tu veux","à ta guise","peu importe",
    "make it better","optimize","improve"
  ];
  const actionVerbsFR = ["ajouter","remplacer","modifier","déplacer","supprimer","réécrire","insérer","mettre à jour","transformer","calculer","afficher"];
  const actionVerbsEN = ["add","replace","change","move","remove","rewrite","insert","update","transform","calculate","display"];

  function countChars(v){ return (v || "").trim().length; }
  function setCounter(el, v){ if(el) el.textContent = countChars(v) ? `${countChars(v)} car.` : ""; }

  function looksVagueSection(text, kind){
    const t = (text || "").trim();
    if(!t) return true;
    const low = t.toLowerCase();
    const hasVague = vagueMarkers.some(m => low.includes(m));

    if(kind === "context"){
      const hasUrl = /(https?:\/\/|www\.)/i.test(t);
      const hasState = /(chargement|initial|overlay|modal|voir tout|voir le détail|pagination|filtre|lazy|dynamique|scroll|ajax)/i.test(t);
      if(t.length < 35) return true;
      if(!hasUrl && !hasState) return true;
      if(hasVague && !hasUrl && !hasState) return true;
      return false;
    }

    if(kind === "where"){
      const hasTargetHint = /(tuile|carte|bloc|section|bouton|cta|prix|image|h1|titre|ligne|au-dessus|en dessous|sous|centré|droite|gauche|overlay|modal|listing)/i.test(t);
      const hasSpecific = /["“”']|\b(iPhone|forfait|€/mois|prix)\b/i.test(t);
      if(t.length < 25) return true;
      if(!hasTargetHint && !hasSpecific) return true;
      if(hasVague && !hasTargetHint) return true;
      return false;
    }

    if(kind === "action"){
      const hasVerb = [...actionVerbsFR, ...actionVerbsEN].some(v => low.includes(v));
      if(t.length < 10) return true;
      if(!hasVerb) return true;
      if(hasVague) return true;
      return false;
    }

    if(kind === "content"){
      const hasConcrete = /["“”']|\b\d+([,.]\d+)?\b|€|\/mois|format|formule|calcul/i.test(t);
      if(t.length < 12) return true;
      if(hasVague && !hasConcrete) return true;
      if(!hasConcrete) return true;
      return false;
    }

    if(kind === "limits"){ return t.length < 18; }
    if(kind === "approach"){ return t.length < 18; }

    return false;
  }

  function needsApproachFromContext(){
    const t = `${els.context.value} ${els.where.value}`.toLowerCase();
    return /(overlay|modal|voir tout|voir le détail|pagination|filtre|lazy|dynamique|ajax|infinite|scroll)/i.test(t);
  }

  function computeQuality(){
    const missing = [];
    const warnings = [];

    const ctx = els.context.value.trim();
    const whr = els.where.value.trim();
    const act = els.action.value.trim();
    const cnt = els.content.value.trim();
    const lim = els.limits.value.trim();
    const app = els.approach.value.trim();

    if(!ctx || looksVagueSection(ctx,"context")){
      missing.push({
        key:"Contexte",
        t:"Contexte insuffisant",
        d:"Ajoute l’URL + au moins 1 état (initial / après clic / overlay / dynamique).",
        example:"URL: https://… / listing. Appliquer au chargement + après clic “voir tout” + dans overlay."
      });
    }
    if(!whr || looksVagueSection(whr,"where")){
      missing.push({
        key:"Où",
        t:"Où trop flou",
        d:"Indique l’élément ciblé ET/OU la position exacte de la modification.",
        example:"Dans les tuiles iPhone 17/17 Pro/17 Pro Max, sous l’image, centré."
      });
    }
    if(!act || looksVagueSection(act,"action")){
      missing.push({
        key:"Action",
        t:"Action manquante",
        d:"Utilise un verbe clair (ajouter / remplacer / calculer / déplacer…).",
        example:"Remplacer la ligne au-dessus du prix."
      });
    }
    if(!cnt || looksVagueSection(cnt,"content")){
      missing.push({
        key:"Contenu",
        t:"Contenu / format manquant",
        d:"Donne le texte exact OU un format + formule (si calcul).",
        example:"“À partir d’1€ …” OU “Afficher 9,99€/mois = prix + |remise|”."
      });
    }

    if(!lim){
      warnings.push({
        key:"Limites",
        t:"Limites absentes (reco)",
        d:"Ajoute les garde-fous (charte/fond/typo/layout).",
        example:"Ne pas modifier le layout. Respecter fond greige + typographie."
      });
    } else if(looksVagueSection(lim,"limits")){
      warnings.push({
        key:"Limites",
        t:"Limites trop courtes",
        d:"Sois concret sur ce qui ne doit pas bouger.",
        example:"Ne pas changer la grille, tailles de typo, couleurs."
      });
    }

    const needApp = needsApproachFromContext();
    if(needApp && !app){
      warnings.push({
        key:"Approche",
        t:"Approche manquante (reco forte)",
        d:"Comme c’est dynamique (overlay/ajouts), précise ré-application + idempotence.",
        example:"MutationObserver + apply() idempotent (data-processed) + overlays."
      });
    } else if(app && looksVagueSection(app,"approach")){
      warnings.push({
        key:"Approche",
        t:"Approche trop courte",
        d:"Décris : ré-application, idempotence, overlay open/close, fallback sans erreurs.",
        example:"Réappliquer à chaque ajout DOM; ne jamais dupliquer; fallback silencieux."
      });
    }

    let score = 100;
    score -= missing.length * 28;
    score -= warnings.length * 12;
    score = Math.max(0, Math.min(100, score));

    const ready = (missing.length === 0 && score >= 70);
    const state = ready ? "ready" : (score >= 50 ? "warn" : "bad");
    return {score, ready, state, missing, warnings, needApp};
  }

  function renderChecks(q){
    const items = [];

    const add = (state, title, desc) => {
      const icon = state === "ok" ? "✓" : (state === "warn" ? "!" : "×");
      items.push(`
        <div class="item ${state}">
          <div class="ico">${icon}</div>
          <div>
            <p class="itT">${title}</p>
            <p class="itD">${desc}</p>
          </div>
        </div>
      `);
    };

    // état par section
    const ctxOk = els.context.value.trim() && !looksVagueSection(els.context.value,"context");
    add(ctxOk ? "ok" : "bad", "Contexte", ctxOk ? "OK — URL/états décrits." : "Manque : URL + états (initial / après clic / overlay).");

    const whereOk = els.where.value.trim() && !looksVagueSection(els.where.value,"where");
    add(whereOk ? "ok" : "bad", "Où (cible/position)", whereOk ? "OK — élément/position identifiables." : "Manque : élément ciblé + position exacte.");

    const actOk = els.action.value.trim() && !looksVagueSection(els.action.value,"action");
    add(actOk ? "ok" : "bad", "Action", actOk ? "OK — verbe d’action clair." : "Manque : verbe (ajouter/remplacer/calculer…).");

    const cntOk = els.content.value.trim() && !looksVagueSection(els.content.value,"content");
    add(cntOk ? "ok" : "bad", "Contenu / format", cntOk ? "OK — texte exact ou format/formule." : "Manque : texte exact OU format/formule.");

    const lim = els.limits.value.trim();
    add(lim ? "ok" : "warn", "Limites", lim ? "OK — garde-fous présents." : "Recommandé : charte/fond/typo/layout.");

    const needApp = q.needApp;
    const app = els.approach.value.trim();
    add(!needApp ? "ok" : (app ? "ok" : "warn"), "Approche (robustesse)",
      !needApp ? "N/A — pas d’indice fort de dynamisme." : (app ? "OK — dynamique cadré." : "Recommandé : ré-application + idempotence + overlays."));

    const ver = els.verify.value.trim();
    add(ver ? "ok" : "warn", "Vérification", ver ? "OK — critères décrits." : "Optionnel : persistance + overlay + style.");

    // Ce qui manque (explicite + exemples)
    const miss = [...q.missing, ...q.warnings];
    if(miss.length){
      const lines = miss.slice(0, 6).map(m => `
        <div class="item ${q.missing.includes(m) ? "bad" : "warn"}">
          <div class="ico">${q.missing.includes(m) ? "×" : "!"}</div>
          <div>
            <p class="itT">${m.key} — ${m.t}</p>
            <p class="itD">${m.d}<br><span style="color: var(--muted2);">Ex : ${m.example}</span></p>
          </div>
        </div>
      `).join("");
      items.push(`<div style="margin-top:6px;"></div>${lines}`);
    }

    els.checks.innerHTML = items.join("");
  }

  function buildPBXPrompt(q){
    const blocks = [];
    blocks.push("Front-end variation only (no back-end changes).");

    blocks.push("\nContexte :\n" + els.context.value.trim());
    blocks.push("\nOù :\n" + els.where.value.trim());
    blocks.push("\nAction :\n" + els.action.value.trim());
    blocks.push("\nContenu :\n" + els.content.value.trim());

    if(els.limits.value.trim()){
      blocks.push("\nLimites :\n" + els.limits.value.trim());
    }

    if(els.approach.value.trim()){
      blocks.push("\nApproche :\n" + els.approach.value.trim());
    } else if(q.needApp){
      blocks.push("\nApproche :\nAppliquer au chargement + réappliquer lors d’ajouts DOM (MutationObserver). Idempotent (pas de doublons). Fonctionner dans overlays si présents. Fallback : ne rien faire si cible introuvable.");
    }

    if(els.verify.value.trim()){
      blocks.push("\nVérification :\n" + els.verify.value.trim());
    }

    blocks.push("\nAttendu :\nGénérer le code robuste qui applique strictement ces règles sans dégrader le design et sans erreur console.");
    return blocks.join("\n").trim();
  }

  function buildMissingPreview(q){
    const lines = [];
    lines.push("Complète les sections ci-dessous pour obtenir un prompt PBX exploitable :\n");
    q.missing.forEach(m => {
      lines.push(`- [OBLIGATOIRE] ${m.key} : ${m.d}`);
      lines.push(`  Ex : ${m.example}\n`);
    });
    q.warnings.forEach(w => {
      lines.push(`- [RECOMMANDÉ] ${w.key} : ${w.d}`);
      lines.push(`  Ex : ${w.example}\n`);
    });
    return lines.join("\n").trim();
  }

  function updateUI(){
    setCounter(els.c_context, els.context.value);
    setCounter(els.c_where, els.where.value);
    setCounter(els.c_action, els.action.value);
    setCounter(els.c_content, els.content.value);
    setCounter(els.c_limits, els.limits.value);
    setCounter(els.c_approach, els.approach.value);
    setCounter(els.c_verify, els.verify.value);

    const q = computeQuality();

    els.scorePill.textContent = `${q.score}% ${q.ready ? "✅" : "⛔"}`;
    els.scoreBar.style.width = `${q.score}%`;

    if(q.state === "ready"){
      els.scoreBar.style.background = "linear-gradient(90deg, #22C55E, #14B8A6)";
      els.dotState.style.background = "var(--good)";
      els.stateLabel.textContent = "Prompt prêt";
      els.genBadge.textContent = "PBX-ready";
      els.result.value = buildPBXPrompt(q);
    } else if(q.state === "warn"){
      els.scoreBar.style.background = "linear-gradient(90deg, #F59E0B, #FBBF24)";
      els.dotState.style.background = "var(--warn)";
      els.stateLabel.textContent = "Presque prêt";
      els.genBadge.textContent = "Incomplet";
      els.result.value = buildMissingPreview(q);
    } else {
      els.scoreBar.style.background = "linear-gradient(90deg, #EF4444, #F97316)";
      els.dotState.style.background = "var(--bad)";
      els.stateLabel.textContent = "Prompt incomplet";
      els.genBadge.textContent = "Incomplet";
      els.result.value = buildMissingPreview(q);
    }

    renderChecks(q);
    save();
  }

  function save(){
    const payload = {
      context: els.context.value,
      where: els.where.value,
      action: els.action.value,
      content: els.content.value,
      limits: els.limits.value,
      approach: els.approach.value,
      verify: els.verify.value
    };
    try{ localStorage.setItem(SKEY, JSON.stringify(payload)); }catch(e){}
  }

  function load(){
    try{
      const raw = localStorage.getItem(SKEY);
      if(!raw) return;
      const p = JSON.parse(raw);
      if(p.context != null) els.context.value = p.context;
      if(p.where != null) els.where.value = p.where;
      if(p.action != null) els.action.value = p.action;
      if(p.content != null) els.content.value = p.content;
      if(p.limits != null) els.limits.value = p.limits;
      if(p.approach != null) els.approach.value = p.approach;
      if(p.verify != null) els.verify.value = p.verify;
    }catch(e){}
  }

  // chips
  document.querySelectorAll(".chip").forEach(chip=>{
    chip.addEventListener("click", ()=>{
      const target = chip.getAttribute("data-target") || "content";
      const add = chip.getAttribute("data-add") || "";
      if(!add) return;
      const el = $(target);
      if(!el) return;
      el.value = el.value.trim() ? (el.value.trim() + "\n\n" + add).trim() : add;
      el.focus();
      updateUI();
    });
  });

  // watchers
  ["context","where","action","content","limits","approach","verify"].forEach(id=>{
    $(id).addEventListener("input", updateUI);
    $(id).addEventListener("change", updateUI);
  });

  // init
  load();
  updateUI();
</script>
</body>
</html>
